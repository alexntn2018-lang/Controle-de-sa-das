<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base de Operações - Controle Unificado</title>
    <!-- Carregando Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Mammoth.js para ler arquivos .docx -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a; /* Fundo Escuro */
            color: #d9c28e; /* Khaki/Tan */
            min-height: 100vh;
        }
        /* Estilos da Tela de Autenticação */
        #auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        /* Estilos para o container principal do APP */
        .tactical-container {
            background-color: #303030; /* Cinza Tático */
            border: 2px solid #495641; /* Borda Verde Oliva */
            box-shadow: 0 0 15px rgba(73, 86, 65, 0.5); /* Sombra suave para profundidade */
        }
        /* Estilos para input/selects */
        input:focus, select:focus {
            border-color: #d9c28e !important;
            box-shadow: 0 0 0 1px #d9c28e !important;
        }
        input, select {
            background-color: #444444;
            color: #f0f0f0;
            border: 1px solid #555;
        }
        
        /* Estilos da Tabela */
        th, td {
            padding: 10px 14px;
            text-align: left;
            border-bottom: 1px solid #444444;
        }
        th {
            background-color: #2b2b2b; /* Cabeçalho Escuro */
            color: #d9c28e;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            font-weight: 700;
        }
        .data-row {
            color: #f0f0f0;
        }
        .data-row:nth-child(even) {
            background-color: #383838;
        }
        .data-row:hover {
            background-color: #495641; /* Verde Oliva no hover */
        }
        /* Botões de Ação */
        .action-button {
            background-color: #495641; 
            color: #f0f0f0;
            font-weight: bold;
        }
        .action-button:hover {
            background-color: #5d6e52; 
        }
        #firebase-error, #auth-status {
            display: none;
            padding: 1rem;
            text-align: center;
            font-weight: bold;
        }
        #firebase-error {
            background-color: #ff3333;
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 9999;
        }

    </style>
    <!-- Importando Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- LÓGICA DE NAVEGAÇÃO INTERNA (Login/Cadastro) ---
        function toggleAuthForms() {
            document.getElementById('login-form-container').classList.toggle('hidden');
            document.getElementById('register-form-container').classList.toggle('hidden');
        }
        window.toggleAuthForms = toggleAuthForms;

        // --- PASSO IMPORTANTE: CONFIGURAÇÃO DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAd6tEf3dBDohA1TCgLn-w4UW1UKE_90tE",
            authDomain: "meu-controle-de-estoque-3344f.firebaseapp.com",
            projectId: "meu-controle-de-estoque-3344f",
            storageBucket: "meu-controle-de-estoque-3344f.appspot.com",
            messagingSenderId: "524659153893",
            appId: "1:524659153893:web:118326d46946ee60306d0c",
            measurementId: "G-BD19J1CTCZ"
        };
        // ----------------------------------------------------

        // --- LÓGICA DO FIREBASE E APLICAÇÃO ---
        setLogLevel('Debug');
        
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let allDepartures = [];
        
        // Referências do DOM
        const logTableBody = document.getElementById('log-table-body');
        const summaryTableBody = document.getElementById('summary-table-body');
        const dateFilterInput = document.getElementById('date-filter');
        const materialInput = document.getElementById('material-name');
        const formStatus = document.getElementById('form-status');
        const loadingIndicator = document.getElementById('loading-indicator');
        const userIdDisplay = document.getElementById('user-id-display');
        const addDepartureForm = document.getElementById('add-departure-form'); 
        const analysisOutput = document.getElementById('analysis-output');
        const batchUploadStatus = document.getElementById('batch-upload-status');
        const firebaseErrorDiv = document.getElementById('firebase-error');
        const authStatus = document.getElementById('auth-status');

        // Validação da configuração do Firebase
        if (!firebaseConfig || !firebaseConfig.projectId || firebaseConfig.projectId === "SEU_PROJETO_ID") {
            console.error("CONFIGURAÇÃO DO FIREBASE INCOMPLETA!");
            firebaseErrorDiv.textContent = "ERRO: A configuração do Firebase está faltando. Edite o arquivo HTML e adicione suas chaves de acesso.";
            firebaseErrorDiv.style.display = 'block';
        } else {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        }

        const collectionPath = `saidas_materiais`;
        
        // --- LÓGICA DE AUTENTICAÇÃO ---
        const handleRegister = (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            authStatus.style.display = 'block';
            authStatus.textContent = "Registrando...";
            authStatus.className = 'text-yellow-400 font-bold p-2 text-center';

            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    authStatus.textContent = "Usuário registrado com sucesso! Faça o login.";
                    authStatus.className = 'text-green-500 font-bold p-2 text-center';
                    setTimeout(() => toggleAuthForms(), 1500);
                })
                .catch((error) => {
                    const errorCode = error.code;
                    let message = "Ocorreu um erro ao registrar.";
                    if (errorCode === 'auth/email-already-in-use') {
                        message = "Este e-mail já está em uso.";
                    } else if (errorCode === 'auth/weak-password') {
                        message = "A senha deve ter pelo menos 6 caracteres.";
                    } else if (errorCode === 'auth/invalid-email') {
                        message = "O formato do e-mail é inválido.";
                    }
                    console.error("Erro de registro:", error);
                    authStatus.textContent = `Erro: ${message}`;
                    authStatus.className = 'text-red-500 font-bold p-2 text-center';
                });
        };

        const handleLogin = (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            authStatus.style.display = 'block';
            authStatus.textContent = "Autenticando...";
            authStatus.className = 'text-yellow-400 font-bold p-2 text-center';

            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => {
                    console.error("Erro de login:", error);
                    authStatus.textContent = "Erro: E-mail ou senha inválidos.";
                    authStatus.className = 'text-red-500 font-bold p-2 text-center';
                });
        };

        const handleLogout = () => {
            signOut(auth);
        };

        if (auth) {
            onAuthStateChanged(auth, (user) => {
                loadingIndicator.style.display = 'none';
                if (user) {
                    // Usuário está logado
                    userId = user.uid;
                    isAuthReady = true;
                    userIdDisplay.textContent = `Usuário: ${user.email}`;

                    document.getElementById('auth-container').classList.add('hidden');
                    document.getElementById('main-app-container').classList.remove('hidden');
                    
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('date').value = today;
                    document.getElementById('date-filter').value = today;
                    
                    setupRealtimeListener();
                } else {
                    // Usuário está deslogado
                    userId = null;
                    isAuthReady = false;
                    document.getElementById('auth-container').classList.remove('hidden');
                    document.getElementById('main-app-container').classList.add('hidden');
                }
            });
        }
        // Adicionando listeners aos forms e botões de auth
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('register-form').addEventListener('submit', handleRegister);
        document.getElementById('logout-button').addEventListener('click', handleLogout);
        
        // --- RESTANTE DA LÓGICA DA APLICAÇÃO ---

        const addDeparture = async (event) => { 
            event.preventDefault();
            const material = materialInput.value.trim();
            const quantity = parseFloat(document.getElementById('quantity').value.trim());
            const date = document.getElementById('date').value.trim();
            const destination = document.getElementById('destination').value.trim();
            const unit = document.getElementById('unit_of_measure').value.trim();
            
            await registerDeparture(material, quantity, date, destination, unit);

            document.getElementById('quantity').value = '';
            materialInput.value = '';
            document.getElementById('destination').value = '';
            document.getElementById('unit_of_measure').value = '';
            materialInput.focus();
        };
        addDepartureForm.addEventListener('submit', addDeparture);

        async function registerDeparture(material, quantity, date, destination, unit) {
            if (!isAuthReady || !userId) {
                formStatus.textContent = "Aguardando autenticação...";
                return false;
            }
            if (!material || isNaN(quantity) || quantity <= 0 || !date || !destination || !unit) {
                formStatus.textContent = `ERRO (item: ${material}): Preencha todos os campos obrigatórios corretamente.`;
                formStatus.classList.remove('text-green-500', 'text-gray-500', 'text-yellow-400');
                formStatus.classList.add('text-red-500', 'font-bold');
                return false;
            }

            try {
                await addDoc(collection(db, collectionPath), {
                    material: material.toUpperCase(),
                    quantity: quantity,
                    date: date, 
                    destination: destination.toUpperCase(),
                    unit_of_measure: unit.toUpperCase(),
                    timestamp: serverTimestamp(),
                    userId: userId,
                    userEmail: auth.currentUser.email
                });
                formStatus.textContent = `Saída de "${material}" REGISTRADA.`;
                formStatus.classList.remove('text-red-500', 'text-gray-500', 'text-yellow-400');
                formStatus.classList.add('text-green-500', 'font-bold');
                return true;
            } catch (e) {
                console.error("Erro ao adicionar documento: ", e);
                formStatus.textContent = "ERRO FATAL: Falha ao registrar. Verifique as regras do Firestore e o console.";
                formStatus.classList.remove('text-green-500', 'text-gray-500', 'text-yellow-400');
                formStatus.classList.add('text-red-500', 'font-bold');
                firebaseErrorDiv.textContent = "ERRO DE ESCRITA: Verifique se o Firestore foi criado e se as Regras de Segurança permitem escrita (use o Modo de Teste).";
                firebaseErrorDiv.style.display = 'block';
                return false;
            }
        }

        const deleteDeparture = async (id, material) => { 
            if (!isAuthReady) {
                console.error("Autenticação não pronta.");
                return;
            }
            formStatus.textContent = `PROCESSANDO: Excluindo registro de ${material}...`;
            formStatus.classList.remove('text-green-500', 'text-red-500');
            formStatus.classList.add('text-yellow-400', 'font-bold');
            try {
                await deleteDoc(doc(db, collectionPath, id));
                formStatus.textContent = `Saída de "${material}" EXCLUÍDA.`;
                formStatus.classList.remove('text-red-500', 'text-yellow-400');
                formStatus.classList.add('text-green-500', 'font-bold');
            } catch (e) {
                console.error("Erro ao excluir documento: ", e);
                formStatus.textContent = "ERRO CRÍTICO: Falha na exclusão. Verifique o console.";
                formStatus.classList.remove('text-green-500', 'text-yellow-400');
                formStatus.classList.add('text-red-500', 'font-bold');
            }
        };
        window.deleteDeparture = deleteDeparture;

        function setupRealtimeListener() {
            if (!db) return;
            const q = query(collection(db, collectionPath));
            onSnapshot(q, (querySnapshot) => {
                if (!isAuthReady) return; 
                const departures = [];
                querySnapshot.forEach((doc) => {
                    departures.push({ id: doc.id, ...doc.data() });
                });
                allDepartures = departures;
                const selectedDate = dateFilterInput.value;
                renderData(allDepartures, selectedDate);
            }, (error) => {
                console.error("Erro ao ouvir dados:", error);
                firebaseErrorDiv.textContent = "ERRO DE LEITURA: Verifique se as Regras de Segurança do Firestore permitem leitura.";
                firebaseErrorDiv.style.display = 'block';
            });
        }
        
        dateFilterInput.addEventListener('change', () => {
             if(isAuthReady) {
                const selectedDate = dateFilterInput.value;
                renderData(allDepartures, selectedDate);
             }
        });

        function renderData(departures, selectedDate) {
            logTableBody.innerHTML = '';
            analysisOutput.innerHTML = '';
            const filteredDepartures = departures.filter(d => d.date === selectedDate);
            
            if (filteredDepartures.length === 0) {
                logTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-gray-500">Nenhuma saída registrada para ${selectedDate}.</td></tr>`; 
            } else {
                filteredDepartures
                    .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0))
                    .forEach((item) => {
                    const row = document.createElement('tr');
                    row.classList.add('data-row');
                    const time = item.timestamp?.toDate ? item.timestamp.toDate().toLocaleTimeString('pt-BR') : 'N/A';
                    row.innerHTML = `
                        <td class="text-sm text-[#d9c28e]">${time}</td>
                        <td class="text-sm text-[#f0f0f0]">${item.material}</td>
                        <td class="text-sm text-[#d9c28e]">${item.unit_of_measure || 'N/A'}</td>
                        <td class="text-sm text-green-500 font-bold">${item.quantity}</td>
                        <td class="text-sm text-[#f0f0f0]">${item.destination || 'N/A'}</td>
                        <td class="text-sm text-gray-400">${item.userEmail ? item.userEmail.split('@')[0] : item.userId.substring(0,8)}</td>
                        <td>
                            <button onclick="deleteDeparture('${item.id}', '${item.material}')" class="p-1 rounded-full text-red-500 hover:bg-red-900/50 transition duration-150 ease-in-out" title="EXCLUIR REGISTRO">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                        </td>
                    `;
                    logTableBody.appendChild(row);
                });
            }
            calculateSummary(filteredDepartures);
        }

        function calculateSummary(filteredDepartures) {
            summaryTableBody.innerHTML = '';
            const summary = {};
            filteredDepartures.forEach(item => {
                const key = `${item.material}|${item.unit_of_measure || 'UNID'}`;
                if (summary[key]) {
                    summary[key] += item.quantity;
                } else {
                    summary[key] = item.quantity;
                }
            });
            const keys = Object.keys(summary).sort();
            if (keys.length === 0) {
                summaryTableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-500">Nenhum resumo para esta data.</td></tr>`;
                return;
            }
            keys.forEach(key => {
                const [material, unit] = key.split('|');
                const row = document.createElement('tr');
                row.classList.add('data-row');
                row.innerHTML = `
                    <td class="text-base font-semibold text-[#f0f0f0]">${material}</td>
                    <td class="text-sm text-[#d9c28e]">${unit}</td>
                    <td class="text-base font-extrabold text-green-500">${summary[key]}</td>
                `;
                summaryTableBody.appendChild(row);
            });
        }
        
        const generateAnalysis = async () => {
            if (summaryTableBody.children.length === 0 || summaryTableBody.children[0].colSpan === 3) {
                analysisOutput.innerHTML = '<p class="text-red-500 font-bold">ERRO: Sem dados de consumo para analisar no dia selecionado.</p>';
                return;
            }
            analysisOutput.innerHTML = '<p class="text-yellow-400 font-bold animate-pulse">PROCESSANDO: Gerando Relatório Tático (Gemini AI)...</p>';
            let data = [];
            for (const row of summaryTableBody.children) {
                const material = row.children[0].textContent;
                const unit = row.children[1].textContent;
                const total = row.children[2].textContent;
                data.push(`${material} (${unit}): ${total}`);
            }
            const userQuery = `Analise a seguinte lista de consumo diário do depósito e gere um breve relatório de status operacional para o Gerente de Logística. O relatório deve: 1. Ser conciso e profissional em português. 2. Destacar os 3 itens com o maior volume de consumo total. 3. Fornecer uma sugestão de ação breve (ex: 'Monitorar estoque' ou 'Revisar pedido'). Lista de Consumo: ${data.join('; ')}`;
            const systemPrompt = "Você é um Analista Logístico Tático de IA. Sua resposta deve ser formatada como um 'STATUS REPORT' formal, usando vocabulário profissional em português. Mantenha o tom de urgência e eficiência. Use formatação Markdown (negrito e listas).";
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Falha ao gerar o texto de análise.";
                analysisOutput.innerHTML = `<div class="p-4 bg-[#2b2b2b] border border-[#495641] mt-4 text-sm whitespace-pre-wrap">${text}</div>`;
            } catch (error) {
                console.error("Erro na chamada da API Gemini:", error);
                analysisOutput.innerHTML = '<p class="text-red-500 font-bold">ERRO FATAL DE COMUNICAÇÃO (GEMINI): Falha na API. Verifique a conexão.</p>';
            }
        };
        window.generateAnalysis = generateAnalysis;

        async function processTextData(text, dateForBatch) {
            const lines = text.split('\n');
            let successCount = 0;
            let errorCount = 0;
            let errorLines = [];

            for (const [index, line] of lines.entries()) {
                const trimmedLine = line.trim();
                if (!trimmedLine) continue;

                const parts = trimmedLine.split(/\s+/).filter(Boolean);

                if (parts.length < 3) {
                    continue; 
                }

                const destination = parts.length > 3 ? parts.pop() : 'COZINHA';
                let quantityStr = parts.pop();
                const unit = parts.pop();
                const material = parts.join(' ');
                
                if (quantityStr.includes('/')) quantityStr = quantityStr.split('/')[0].trim();
                if (quantityStr.includes('½')) quantityStr = "0.5";
                
                const quantity = parseFloat(quantityStr.replace(',', '.'));

                if (isNaN(quantity) || !material || !unit) {
                    errorCount++;
                    errorLines.push(index + 1);
                    continue;
                }

                const success = await registerDeparture(material, quantity, dateForBatch, destination, unit);
                if (success) successCount++;
                else {
                    errorCount++;
                    errorLines.push(index + 1);
                }
            }

            let summaryMessage = `<p class="text-green-500 font-bold">${successCount} registros importados com sucesso.</p>`;
            if (errorCount > 0) {
                summaryMessage += `<p class="text-red-500 font-bold">${errorCount} linhas com formato inválido foram ignoradas. Verifique as linhas: ${errorLines.join(', ')}</p>`;
            }
            if (successCount === 0 && errorCount === 0) {
                 summaryMessage = `<p class="text-yellow-400 font-bold">Nenhum dado válido para importação foi encontrado no arquivo.</p>`;
            }

            batchUploadStatus.innerHTML = summaryMessage;
        }

        const handleFileUpload = async () => {
            const fileInput = document.getElementById('word-file-input');
            const file = fileInput.files[0];
            const dateForBatch = document.getElementById('date').value;

            if (!file || !dateForBatch) {
                batchUploadStatus.innerHTML = `<p class="text-red-500 font-bold">ERRO: Selecione um arquivo e preencha a data da operação.</p>`;
                return;
            }
            
            batchUploadStatus.innerHTML = '<p class="text-yellow-400 font-bold animate-pulse">PROCESSANDO ARQUIVO...</p>';
            const reader = new FileReader();

            if (file.name.endsWith('.docx')) {
                reader.onload = async (event) => {
                    try {
                        const result = await mammoth.extractRawText({ arrayBuffer: event.target.result });
                        await processTextData(result.value, dateForBatch);
                    } catch (err) {
                        batchUploadStatus.innerHTML = '<p class="text-red-500 font-bold">ERRO: Falha ao ler o arquivo .docx.</p>';
                    }
                };
                reader.readAsArrayBuffer(file);
            } else if (file.name.endsWith('.txt')) {
                reader.onload = async (event) => {
                    try {
                        await processTextData(event.target.result, dateForBatch);
                    } catch (err) {
                        batchUploadStatus.innerHTML = '<p class="text-red-500 font-bold">ERRO: Falha ao ler o arquivo .txt.</p>';
                    }
                };
                reader.readAsText(file);
            } else {
                 batchUploadStatus.innerHTML = '<p class="text-red-500 font-bold">ERRO: Tipo de arquivo não suportado.</p>';
            }
        };
        window.handleFileUpload = handleFileUpload;

        const materialSuggestions = ["Cebola", "Batatas", "Abóbora", "Abobrinha", "Chuchu", "Cenoura", "Tomate", "Pimentão", "Cheiro verde", "Agrião", "Couve", "Loro", "Beterraba", "Aipim", "Batata doce", "Pepino", "Repolho", "Alface", "Quiabo", "Rúcula", "Alho", "Melancia", "Banana", "Limão", "Laranja", "Mamão", "Melão", "Abacaxi", "Maçã", "Tangerina", "Manga", "Manteiga", "Água mineral", "Água mineral com gás", "Refrigerante sabor guaraná", "Refrigerante sabor uva", "Refrigerante sabor cola", "Refrigerante coca cola", "Coca cola zero", "Ovo", "Requeijão nazza", "Salsicha", "Queijo", "Presunto", "Mortadela", "Bacon", "Linguiça", "Carne seca", "Massa de Pastel", "Ovo de codorna", "Cerveja império", "Cerveja Heineken", "Cerveja Stella", "Red bull", "Smirnoff ice", "Kovak", "Vinho Espumante", "Gin", "Monin", "Peixe", "Coxa e sobrecoxa", "Peito de frango", "Patinho", "Lagarto", "Lombo", "Miolo da pá", "Paleta sem músculo", "Coxão duro", "Fígado", "Coxão mole", "Coração alcatra", "Maminha da alcatra", "Acém", "Hambúrguer", "Batata frita", "Pão de queijo", "Garganta suína", "Máscara suína", "Joelho suíno", "Ponta de costela", "Kibe", "Bolinha de queijo", "Salgadinho de aipim", "Coxinha", "Risole de camarão", "Gelo", "Patinho cortado", "Charuto de carne moída", "Charuto de peito de frango", "Arroz branco", "Arroz parabolizado", "Macarrão", "Óleo", "Açúcar", "Feijão carioca", "Feijão preto", "Leite em pó", "Café", "Farinha de trigo", "Fubá", "Farinha de mandioca", "Farinha de rosca", "Xarope de guaraná", "Xarope de caju", "Ketchup sachê", "Mostarda sachê", "Maionese", "Ervilha", "Colorau", "Feijão Fradinho", "Sal fino", "Sal grosso", "Trigo Kibe", "Extrato de tomate", "Azeite de oliva", "Vinagre", "Óleo misto", "Molho de pimenta", "Azeitonas", "Batata palha", "Milho em conserva", "Ervilha em conserva", "Leite de coco", "Creme de leite", "Leite condensado", "Adoçante", "Canela em pó", "Fermento biológico", "Fermento químico", "Creme de Confeiteiro", "Suco em pó", "Amido de milho", "Gelatina", "Doce em pasta", "Achocolatado", "Mariola", "Amendoim", "Rosquinha Mabel", "Paçoca", "Geleia de mocotó", "Sequilhos", "Pit Stop", "AtivPlus", "Gatorade", "Biscoito Tucs", "Biscoito passatempo", "Guaracamp", "Biscoito amanteigado", "Amanteigado Goiabinha", "Barrinha de ração", "Rapadura"];
        const unitSuggestions = ["UN", "KG", "L", "Saco", "Caixa", "Pç", "Pcte", "Fardo", "Balde", "Galao"];
        
        function fillDatalists() {
            const materialDatalist = document.getElementById('material-suggestions');
            materialSuggestions.forEach(material => {
                const option = document.createElement('option');
                option.value = material;
                materialDatalist.appendChild(option);
            });

            const unitDatalist = document.getElementById('unit-suggestions');
            unitSuggestions.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit;
                unitDatalist.appendChild(option);
            });
        }
        window.onload = fillDatalists;
    </script>
</head>
<body>
    
    <div id="firebase-error"></div>
    <div id="loading-indicator" class="fixed inset-0 bg-black/50 flex justify-center items-center z-50">
        <p class="text-yellow-400 font-bold text-lg">Carregando Sistema...</p>
    </div>

    <div id="auth-container" class="">
        <div class="max-w-md w-full bg-[#303030] p-10 shadow-2xl border-4 border-[#495641] rounded-lg">
            <!-- Container do Login (visível por padrão) -->
            <div id="login-form-container">
                <h1 class="text-3xl font-extrabold mb-4 border-b-2 border-[#495641] pb-2 text-center text-[#d9c28e]">LOGIN</h1>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-[#d9c28e]">Email</label>
                        <input type="email" id="login-email" required class="mt-1 block w-full rounded-none shadow-sm focus:ring-1 p-2 border">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-[#d9c28e]">Senha</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full rounded-none shadow-sm focus:ring-1 p-2 border">
                    </div>
                    <button type="submit" class="w-full action-button py-2 px-6 rounded-none border border-[#d9c28e]">Entrar</button>
                </form>
                <p class="mt-4 text-center text-sm">
                    Não tem uma conta? <button onclick="toggleAuthForms()" class="font-semibold text-[#d9c28e] hover:underline">Cadastre-se</button>
                </p>
            </div>
            <!-- Container do Cadastro (oculto por padrão) -->
            <div id="register-form-container" class="hidden">
                <h1 class="text-3xl font-extrabold mb-4 border-b-2 border-[#495641] pb-2 text-center text-[#d9c28e]">CADASTRO</h1>
                <form id="register-form" class="space-y-4">
                    <div>
                        <label for="register-email" class="block text-sm font-medium text-[#d9c28e]">Email</label>
                        <input type="email" id="register-email" required class="mt-1 block w-full rounded-none shadow-sm focus:ring-1 p-2 border">
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-[#d9c28e]">Senha (mínimo 6 caracteres)</label>
                        <input type="password" id="register-password" required class="mt-1 block w-full rounded-none shadow-sm focus:ring-1 p-2 border">
                    </div>
                    <button type="submit" class="w-full action-button py-2 px-6 rounded-none border border-[#d9c28e]">Registrar</button>
                </form>
                <p class="mt-4 text-center text-sm">
                    Já tem uma conta? <button onclick="toggleAuthForms()" class="font-semibold text-[#d9c28e] hover:underline">Faça o login</button>
                </p>
            </div>
            <div id="auth-status" class="mt-4"></div>
        </div>
    </div>


    <div id="main-app-container" class="hidden p-4 sm:p-8 w-full">
        <div class="max-w-4xl mx-auto">
            <header class="mb-8 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-extrabold text-[#d9c28e] mb-2 border-b-2 border-[#495641] pb-2">
                        TERMINAL DE REGISTRO
                    </h1>
                    <p id="user-id-display" class="text-xs sm:text-sm text-gray-400 font-mono"></p>
                </div>
                <button id="logout-button" class="action-button text-xs sm:text-sm font-bold py-2 px-4 rounded-md transition duration-150">Sair</button>
            </header>

            <!-- Seção de Cadastro de Saída -->
            <div class="p-6 mb-8 tactical-container">
                <h2 class="text-xl font-semibold text-[#d9c28e] mb-4 border-b border-gray-600 pb-2">
                    REGISTRO MANUAL
                </h2>
                <form id="add-departure-form" class="space-y-4"> 
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label for="date" class="block text-sm font-medium text-[#d9c28e]">DATA DA OPERAÇÃO</label>
                            <input type="date" id="date" required class="mt-1 block w-full rounded-none shadow-sm focus:ring-1 p-2 border">
                        </div>
                        <div class="md:col-span-1">
                            <label for="destination" class="block text-sm font-medium text-[#d9c28e]">DESTINO (UNIDADE)</label>
                            <input type="text" id="destination" required placeholder="Ex: COZINHA" class="mt-1 block w-full rounded-none shadow-sm focus:ring-1 p-2 border">
                        </div>
                        <div class="md:col-span-2">
                            <label for="material-name" class="block text-sm font-medium text-[#d9c28e]">CÓDIGO DO MATERIAL</label>
                            <input type="text" id="material-name" list="material-suggestions" required placeholder="Digite o material" class="mt-1 block w-full rounded-none shadow-sm focus:ring-1 p-2 border uppercase">
                            <datalist id="material-suggestions"></datalist>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="unit_of_measure" class="block text-sm font-medium text-[#d9c28e]">UNIDADE (KG, UN, L)</label>
                            <input type="text" id="unit_of_measure" list="unit-suggestions" required placeholder="EX: KG" class="mt-1 block w-full rounded-none shadow-sm focus:ring-1 p-2 border uppercase">
                            <datalist id="unit-suggestions"></datalist>
                        </div>
                        <div>
                            <label for="quantity" class="block text-sm font-medium text-[#d9c28e]">QUANTIDADE SAÍDA</label>
                            <input type="number" id="quantity" step="0.01" required min="0.01" placeholder="Ex: 1.5 ou 10" class="mt-1 block w-full rounded-none shadow-sm focus:ring-1 p-2 border">
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center pt-2">
                        <button type="submit" class="w-full sm:w-auto action-button hover:text-white font-bold py-2 px-6 rounded-none transition duration-150 ease-in-out border border-[#d9c28e]">
                            EXECUTAR REGISTRO
                        </button>
                        <p id="form-status" class="text-sm mt-3 sm:mt-0 sm:ml-4 text-gray-500 font-bold"></p>
                    </div>
                </form>
            </div>

            <!-- Seção de Registro em Lote -->
            <div class="p-6 mb-8 tactical-container">
                <h2 class="text-xl font-semibold text-[#d9c28e] mb-4 border-b border-gray-600 pb-2">
                    REGISTRO EM LOTE (VIA ARQUIVO)
                </h2>
                <div class="bg-gray-800/50 p-4 border border-dashed border-gray-600 mb-4 text-sm">
                    <h3 class="font-bold text-yellow-400">INSTRUÇÕES DE FORMATAÇÃO:</h3>
                    <p class="mt-2 text-gray-300">Crie um arquivo (.docx ou .txt) com as colunas na ordem: <code class="bg-black/50 p-1 font-mono text-xs">MATERIAL UNIDADE QUANTIDADE DESTINO</code></p>
                    <p class="mt-2 text-gray-400"><strong>IMPORTANTE:</strong> A data será a que estiver no campo "DATA DA OPERAÇÃO" acima.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                    <div>
                        <label for="word-file-input" class="block text-sm font-medium text-[#d9c28e] mb-1">ARQUIVO DE DADOS (.DOCX, .TXT)</label>
                        <input type="file" id="word-file-input" accept=".docx,.txt" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-none file:border-0 file:text-sm file:font-semibold file:bg-[#495641] file:text-white hover:file:bg-green-700">
                    </div>
                    <div class="self-end">
                         <button onclick="handleFileUpload()" class="w-full action-button hover:text-white font-bold py-2 px-6 rounded-none transition duration-150 ease-in-out border border-[#d9c28e]">
                            PROCESSAR ARQUIVO
                        </button>
                    </div>
                </div>
                 <div id="batch-upload-status" class="mt-4 text-sm font-bold"></div>
            </div>

            <!-- Seção de Filtro e Resumo/Log -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="p-6 tactical-container">
                    <h2 class="text-xl font-semibold text-green-500 mb-4 border-b border-gray-600 pb-2">
                        RELATÓRIO DE CONSUMO DIÁRIO
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-[#444444] rounded-none overflow-hidden">
                            <thead><tr><th class="bg-[#495641]">MATERIAL</th><th class="bg-[#495641]">UNID.</th><th class="bg-[#495641]">TOTAL</th></tr></thead>
                            <tbody id="summary-table-body" class="bg-[#303030] divide-y divide-[#444444]"></tbody>
                        </table>
                    </div>
                    <div class="mt-6 border-t border-gray-600 pt-4">
                        <button onclick="generateAnalysis()" class="action-button hover:bg-green-700 text-sm font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out">
                            GERAR RELATÓRIO TÁTICO (AI) ✨
                        </button>
                        <div id="analysis-output" class="mt-4 text-[#d9c28e]"></div>
                    </div>
                </div>
                <div class="p-6 tactical-container">
                    <h2 class="text-xl font-semibold text-[#d9c28e] mb-4 border-b border-gray-600 pb-2">
                        LOG DE TRANSAÇÕES DO DIA
                    </h2>
                    <div class="mb-4">
                        <label for="date-filter" class="block text-sm font-medium text-[#d9c28e]">SELECIONAR DATA DE REFERÊNCIA:</label>
                        <input type="date" id="date-filter" class="mt-1 block w-full rounded-none shadow-sm focus:ring-1 p-2 border">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-[#444444] rounded-none overflow-hidden">
                            <thead><tr><th class="bg-[#3b3b3b]">HORA</th><th class="bg-[#3b3b3b]">MATERIAL</th><th class="bg-[#3b3b3b]">UNID.</th><th class="bg-[#3b3b3b]">QTD.</th><th class="bg-[#3b3b3b]">DESTINO</th><th class="bg-[#3b3b3b]">POR</th><th class="bg-[#3b3b3b]">AÇÕES</th></tr></thead>
                            <tbody id="log-table-body" class="bg-[#303030] divide-y divide-[#444444]"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

