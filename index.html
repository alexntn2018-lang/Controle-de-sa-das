<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Estoque - Acesso Unificado</title>
    <!-- Carregando Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Mammoth.js para ler arquivos .docx -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <!-- Fonte Padrão do Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* Estilização Base com o Novo Tema Casual */
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f3f4f6; /* Fundo Cinza Claro (Tailwind gray-100) */
            color: #1f2937; /* Texto Escuro Principal (Tailwind gray-800) */
            min-height: 100vh;
        }
        
        /* Tela de Autenticação Limpa e Moderna */
        #auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #e5e7eb; /* Cinza um pouco mais escuro (Tailwind gray-200) */
        }
        #auth-card {
            background-color: white;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-radius: 1rem; /* Cantos bem arredondados */
        }

        /* Estilos dos Containers Principais */
        .content-container {
            background-color: white;
            border: 1px solid #e5e7eb; /* Borda Cinza Clara (Tailwind gray-200) */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 0.75rem; /* Cantos arredondados */
        }
        
        /* Inputs e Selects Modernizados */
        input:focus, select:focus {
            border-color: #3b82f6 !important; /* Azul Primário */
            box-shadow: 0 0 0 1px #3b82f6 !important;
            outline: none;
        }
        input, select {
            background-color: #f9fafb; /* Cinza bem claro (Tailwind gray-50) */
            color: #1f2937;
            border: 1px solid #d1d5db; /* Cinza (Tailwind gray-300) */
            border-radius: 0.5rem; /* Cantos arredondados */
        }
        
        /* Estilo para input readonly */
        input[readonly] {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #6b7280; /* text-gray-500 */
            cursor: not-allowed;
        }

        /* Tabelas com Novo Design Limpo */
        th {
            background-color: #f9fafb; /* Cinza bem claro */
            color: #4b5563; /* Texto cinza escuro */
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            font-weight: 600;
            padding: 12px 16px;
            text-align: left;
        }
        td {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb; /* Cinza claro */
        }
        .data-row:nth-child(even) {
            background-color: #f9fafb; /* Fundo alternado sutil */
        }
        .data-row:hover {
            background-color: #dbeafe; /* Azul bem claro no hover */
        }
        
        /* Botões com o Novo Tema */
        .action-button {
            background-color: #3b82f6; /* Azul Primário */
            color: white;
            font-weight: 500;
            border: none;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .action-button:hover {
            background-color: #2563eb; /* Azul mais escuro */
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .secondary-button {
            background-color: transparent;
            border: 1px solid #d1d5db; /* Borda cinza */
            color: #374151; /* Texto cinza escuro */
        }
        .secondary-button:hover {
            background-color: #f9fafb;
            border-color: #9ca3af;
        }
        
        .dashboard-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid #e5e7eb;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: #3b82f6; /* Borda azul no hover */
        }
    </style>
    <!-- Importando Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- LÓGICA DE NAVEGAÇÃO INTERNA (Login/Cadastro) ---
        function toggleAuthForms() {
            document.getElementById('login-form-container').classList.toggle('hidden');
            document.getElementById('register-form-container').classList.toggle('hidden');
        }
        window.toggleAuthForms = toggleAuthForms;

        // --- PASSO IMPORTANTE: CONFIGURAÇÃO DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAd6tEf3dBDohA1TCgLn-w4UW1UKE_90tE",
            authDomain: "meu-controle-de-estoque-3344f.firebaseapp.com",
            projectId: "meu-controle-de-estoque-3344f",
            storageBucket: "meu-controle-de-estoque-3344f.appspot.com",
            messagingSenderId: "524659153893",
            appId: "1:524659153893:web:118326d46946ee60306d0c",
            measurementId: "G-BD19J1CTCZ"
        };
        // ----------------------------------------------------

        // --- LÓGICA DO FIREBASE E APLICAÇÃO ---
        setLogLevel('Debug');
        
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let allDepartures = [];
        let unsubscribe; // Para o listener do snapshot
        
        // Referências do DOM
        const logTableBody = document.getElementById('log-table-body');
        const summaryTableBody = document.getElementById('summary-table-body');
        const weeklySummaryTableBody = document.getElementById('weekly-summary-table-body');
        const monthlySummaryTableBody = document.getElementById('monthly-summary-table-body');
        const dateFilterInput = document.getElementById('date-filter');
        const weekMonthFilterInput = document.getElementById('week-month-filter');
        const weekNumberFilterInput = document.getElementById('week-number-filter');
        const monthFilterInput = document.getElementById('month-filter');
        const materialInput = document.getElementById('material-name'); // Agora é um <select>
        const unitInput = document.getElementById('unit_of_measure'); // Input de unidade
        const formStatus = document.getElementById('form-status');
        const loadingIndicator = document.getElementById('loading-indicator');
        const userIdDisplay = document.getElementById('user-id-display');
        const addDepartureForm = document.getElementById('add-departure-form'); 
        const analysisOutput = document.getElementById('analysis-output');
        const topMonthOutput = document.getElementById('top-month-output');
        const batchUploadStatus = document.getElementById('batch-upload-status');
        const authStatus = document.getElementById('auth-status');
        const dashboardContainer = document.getElementById('dashboard-container');
        const registroContainer = document.getElementById('registro-container');
        const relatoriosContainer = document.getElementById('relatorios-container');
        const semanalContainer = document.getElementById('semanal-container');
        const mensalContainer = document.getElementById('mensal-container');

        // --- LÓGICA DE NAVEGAÇÃO PÓS-LOGIN ---
        function showDashboard() {
            [dashboardContainer].forEach(c => c.classList.remove('hidden'));
            [registroContainer, relatoriosContainer, semanalContainer, mensalContainer].forEach(c => c.classList.add('hidden'));
        }
        window.showDashboard = showDashboard;
        function showRegistro() {
            [registroContainer].forEach(c => c.classList.remove('hidden'));
            [dashboardContainer, relatoriosContainer, semanalContainer, mensalContainer].forEach(c => c.classList.add('hidden'));
        }
        window.showRegistro = showRegistro;
        function showRelatorios() {
            [relatoriosContainer].forEach(c => c.classList.remove('hidden'));
            [dashboardContainer, registroContainer, semanalContainer, mensalContainer].forEach(c => c.classList.add('hidden'));
        }
        window.showRelatorios = showRelatorios;
        function showSemanal() {
            [semanalContainer].forEach(c => c.classList.remove('hidden'));
            [dashboardContainer, registroContainer, relatoriosContainer, mensalContainer].forEach(c => c.classList.add('hidden'));
        }
        window.showSemanal = showSemanal;
        function showMensal() {
            [mensalContainer].forEach(c => c.classList.remove('hidden'));
            [dashboardContainer, registroContainer, relatoriosContainer, semanalContainer].forEach(c => c.classList.add('hidden'));
        }
        window.showMensal = showMensal;

        // Validação da configuração do Firebase
        if (!firebaseConfig || !firebaseConfig.projectId || firebaseConfig.projectId === "SEU_PROJETO_ID") {
            console.error("CONFIGURAÇÃO DO FIREBASE INCOMPLETA!");
        } else {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        }

        const collectionPath = `saidas_materiais`;
        
        // --- LÓGICA DE AUTENTICAÇÃO ---
        const handleRegister = (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            authStatus.style.display = 'block';
            authStatus.textContent = "Registrando...";
            authStatus.className = 'text-center text-sm text-gray-500 mt-4';
            createUserWithEmailAndPassword(auth, email, password)
                .then(() => {
                    authStatus.textContent = "Usuário registrado com sucesso! Faça o login.";
                    authStatus.className = 'text-center text-sm text-green-600 mt-4';
                    setTimeout(() => toggleAuthForms(), 1500);
                })
                .catch((error) => {
                    let msg = "Ocorreu um erro ao registrar.";
                    if (error.code === 'auth/email-already-in-use') msg = "Este e-mail já está em uso.";
                    else if (error.code === 'auth/weak-password') msg = "A senha deve ter pelo menos 6 caracteres.";
                    authStatus.textContent = `Erro: ${msg}`;
                    authStatus.className = 'text-center text-sm text-red-600 mt-4';
                });
        };
        const handleLogin = (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            authStatus.style.display = 'block';
            authStatus.textContent = "Autenticando...";
            authStatus.className = 'text-center text-sm text-gray-500 mt-4';
            signInWithEmailAndPassword(auth, email, password)
                .then(() => authStatus.style.display = 'none')
                .catch(() => {
                    authStatus.textContent = "Erro: E-mail ou senha inválidos.";
                    authStatus.className = 'text-center text-sm text-red-600 mt-4';
                });
        };
        const handleLogout = () => {
            if (unsubscribe) { unsubscribe(); unsubscribe = null; }
            signOut(auth);
        };
        
        // --- FUNÇÕES DE DATA ---
        function getWeekOfMonthDateRange(yearMonth, weekNumber) {
            const [year, month] = yearMonth.split('-').map(Number);
            const weekNum = parseInt(weekNumber, 10);
            
            let startDay, endDay;
            if (weekNum === 1) {
                startDay = 1;
                endDay = 7;
            } else if (weekNum === 2) {
                startDay = 8;
                endDay = 14;
            } else if (weekNum === 3) {
                startDay = 15;
                endDay = 21;
            } else { // weekNum é 4
                startDay = 22;
                endDay = new Date(year, month, 0).getDate(); // Último dia do mês
            }

            const startDate = new Date(year, month - 1, startDay);
            const endDate = new Date(year, month - 1, endDay);
            
            return {
                start: startDate.toISOString().split('T')[0],
                end: endDate.toISOString().split('T')[0]
            };
        }
        
        function populateMonthSelectors() {
            const months = [];
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            let d = new Date();
            for (let i=0; i < 12; i++) {
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                months.push({ value: `${year}-${month}`, text: `${monthNames[d.getMonth()]} de ${year}` });
                d.setMonth(d.getMonth() - 1);
            }
            weekMonthFilterInput.innerHTML = months.map(m => `<option value="${m.value}">${m.text}</option>`).join('');
            if(monthFilterInput) {
                monthFilterInput.value = months[0].value;
            }
        }

        if (auth) {
            onAuthStateChanged(auth, (user) => {
                loadingIndicator.style.display = 'none';
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    userIdDisplay.textContent = `${user.email}`;
                    document.getElementById('auth-container').classList.add('hidden');
                    document.getElementById('main-app-container').classList.remove('hidden');
                    showDashboard();
                    window.scrollTo(0, 0);
                    const today = new Date();
                    document.getElementById('date').value = today.toISOString().split('T')[0];
                    document.getElementById('date-filter').value = today.toISOString().split('T')[0];
                    const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                    monthFilterInput.value = currentMonth;
                    populateMonthSelectors();
                    weekMonthFilterInput.value = currentMonth;
                    if (!unsubscribe) setupRealtimeListener();
                } else {
                    userId = null; isAuthReady = false;
                    document.getElementById('auth-container').classList.remove('hidden');
                    document.getElementById('main-app-container').classList.add('hidden');
                }
            });
        }
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('register-form').addEventListener('submit', handleRegister);
        document.getElementById('logout-button').addEventListener('click', handleLogout);
        
        // --- LÓGICA PRINCIPAL DA APLICAÇÃO ---
        async function registerDeparture(material, quantity, date, destination, unit) {
            if (!isAuthReady) return false;
            // Validação atualizada: checa se material e unidade foram selecionados
            if (!material || isNaN(quantity) || quantity <= 0 || !date || !destination || !unit) {
                formStatus.textContent = `ERRO: Preencha todos os campos corretamente.`;
                formStatus.className = 'text-sm mt-3 sm:mt-0 sm:ml-4 font-semibold text-red-600';
                return false;
            }
            try {
                await addDoc(collection(db, collectionPath), {
                    material: material.toUpperCase(), // Salva o nome de exibição, mas em maiúsculo
                    quantity, date, 
                    destination: destination.toUpperCase(), unit_of_measure: unit.toUpperCase(),
                    timestamp: serverTimestamp(), userId, userEmail: auth.currentUser.email
                });
                formStatus.textContent = `Saída de "${material}" registrada.`;
                formStatus.className = 'text-sm mt-3 sm:mt-0 sm:ml-4 font-semibold text-green-600';
                return true;
            } catch (e) {
                formStatus.textContent = "ERRO: Falha ao registrar.";
                formStatus.className = 'text-sm mt-3 sm:mt-0 sm:ml-4 font-semibold text-red-600';
                return false;
            }
        }
        const addDeparture = async (e) => { 
            e.preventDefault();
            const form = e.target;
            
            // Lê os valores do form (agora com o <select>)
            const selectedMaterial = form.elements['material-name'].value;
            const predefinedUnit = masterMaterialList[selectedMaterial]?.unit || ''; // Pega a unidade da lista

            await registerDeparture(
                masterMaterialList[selectedMaterial]?.displayName || '', // Pega o nome de exibição
                parseFloat(form.elements['quantity'].value.trim()),
                form.elements['date'].value.trim(),
                form.elements['destination'].value.trim(),
                predefinedUnit // Usa a unidade predefinida
            );
            
            form.reset(); // Reseta o formulário
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            unitInput.value = ''; // Limpa o campo de unidade
            form.elements['material-name'].focus();
        };
        addDepartureForm.addEventListener('submit', addDeparture);

        const deleteDeparture = async (id, material) => { 
            if (!isAuthReady) return;
            // NOTA: confirm() e alert() não são permitidos neste ambiente.
            console.log(`Solicitação de exclusão para: ${material} (ID: ${id}). Excluindo diretamente.`);
            try {
                await deleteDoc(doc(db, collectionPath, id));
                console.log("Registro excluído com sucesso.");
            } catch (e) {
                console.error("ERRO: Falha na exclusão.", e);
            }
        };
        window.deleteDeparture = deleteDeparture;

        function setupRealtimeListener() {
            if (!db) return;
            const q = query(collection(db, collectionPath));
            unsubscribe = onSnapshot(q, (querySnapshot) => {
                if (!isAuthReady) return; 
                allDepartures = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderData(dateFilterInput.value);
                renderWeeklySummary();
                renderMonthlySummary();
            }, (error) => {
                console.error("Erro de leitura do Firestore: ", error);
            });
        }
        
        dateFilterInput.addEventListener('change', () => isAuthReady && renderData(dateFilterInput.value));
        weekMonthFilterInput.addEventListener('change', () => isAuthReady && renderWeeklySummary());
        weekNumberFilterInput.addEventListener('change', () => isAuthReady && renderWeeklySummary());
        monthFilterInput.addEventListener('input', () => isAuthReady && renderMonthlySummary());

        // --- INÍCIO: LÓGICA DE CATEGORIZAÇÃO E LISTA MESTRA ---
        
        // Esta é a nova "Fonte da Verdade" para todos os materiais.
        // A chave (ex: "CEBOLA") é usada para referência interna e validação.
        const masterMaterialList = {
            // Hortifrúti
            "CEBOLA": { displayName: "Cebola", unit: "KG", category: "Hortifrúti" },
            "BATATAS": { displayName: "Batatas", unit: "KG", category: "Hortifrúti" },
            "ABOBORA": { displayName: "Abóbora", unit: "KG", category: "Hortifrúti" },
            "ABOBRINHA": { displayName: "Abobrinha", unit: "KG", category: "Hortifrúti" },
            "CHUCHU": { displayName: "Chuchu", unit: "KG", category: "Hortifrúti" },
            "CENOURA": { displayName: "Cenoura", unit: "KG", category: "Hortifrúti" },
            "TOMATE": { displayName: "Tomate", unit: "KG", category: "Hortifrúti" },
            "PIMENTAO": { displayName: "Pimentão", unit: "KG", category: "Hortifrúti" },
            "CHEIRO VERDE": { displayName: "Cheiro verde", unit: "UN", category: "Hortifrúti" },
            "AGRIAO": { displayName: "Agrião", unit: "UN", category: "Hortifrúti" },
            "COUVE": { displayName: "Couve", unit: "UN", category: "Hortifrúti" },
            "LORO": { displayName: "Loro", unit: "UN", category: "Hortifrúti" },
            "BETERRABA": { displayName: "Beterraba", unit: "KG", category: "Hortifrúti" },
            "AIPIM": { displayName: "Aipim", unit: "KG", category: "Hortifrúti" },
            "BATATA DOCE": { displayName: "Batata doce", unit: "KG", category: "Hortifrúti" },
            "PEPINO": { displayName: "Pepino", unit: "KG", category: "Hortifrúti" },
            "REPOLHO": { displayName: "Repolho", unit: "UN", category: "Hortifrúti" },
            "ALFACE": { displayName: "Alface", unit: "UN", category: "Hortifrúti" },
            "QUIABO": { displayName: "Quiabo", unit: "KG", category: "Hortifrúti" },
            "RUCULA": { displayName: "Rúcula", unit: "UN", category: "Hortifrúti" },
            "ALHO": { displayName: "Alho", unit: "KG", category: "Hortifrúti" },
            
            // Frutas
            "MELANCIA": { displayName: "Melancia", unit: "KG", category: "Frutas" },
            "BANANA": { displayName: "Banana", unit: "KG", category: "Frutas" },
            "LIMAO": { displayName: "Limão", unit: "KG", category: "Frutas" },
            "LARANJA": { displayName: "Laranja", unit: "KG", category: "Frutas" },
            "MAMAO": { displayName: "Mamão", unit: "UN", category: "Frutas" },
            "MELAO": { displayName: "Melão", unit: "UN", category: "Frutas" },
            "ABACAXI": { displayName: "Abacaxi", unit: "UN", category: "Frutas" },
            "MACA": { displayName: "Maçã", unit: "KG", category: "Frutas" },
            "TANGERINA": { displayName: "Tangerina", unit: "KG", category: "Frutas" },
            "MANGA": { displayName: "Manga", unit: "KG", category: "Frutas" },
            
            // Proteínas & Frios
            "OVO": { displayName: "Ovo", unit: "UN", category: "Proteínas & Frios" },
            "OVO DE CODORNA": { displayName: "Ovo de codorna", unit: "UN", category: "Proteínas & Frios" },
            "SALSICHA": { displayName: "Salsicha", unit: "KG", category: "Proteínas & Frios" },
            "PRESUNTO": { displayName: "Presunto", unit: "KG", category: "Proteínas & Frios" },
            "MORTADELA": { displayName: "Mortadela", unit: "KG", category: "Proteínas & Frios" },
            "BACON": { displayName: "Bacon", unit: "KG", category: "Proteínas & Frios" },
            "LINGUICA": { displayName: "Linguiça", unit: "KG", category: "Proteínas & Frios" },
            "CARNE SECA": { displayName: "Carne seca", unit: "KG", category: "Proteínas & Frios" },
            "PEIXE": { displayName: "Peixe", unit: "KG", category: "Proteínas & Frios" },
            "COXA E SOBRECOXA": { displayName: "Coxa e sobrecoxa", unit: "KG", category: "Proteínas & Frios" },
            "PEITO DE FRANGO": { displayName: "Peito de frango", unit: "KG", category: "Proteínas & Frios" },
            "PATINHO": { displayName: "Patinho", unit: "KG", category: "Proteínas & Frios" },
            "LAGARTO": { displayName: "Lagarto", unit: "KG", category: "Proteínas & Frios" },
            "LOMBO": { displayName: "Lombo", unit: "KG", category: "Proteínas & Frios" },
            "MIOLO DA PA": { displayName: "Miolo da pá", unit: "KG", category: "Proteínas & Frios" },
            "PALETA SEM MUSCULO": { displayName: "Paleta sem músculo", unit: "KG", category: "Proteínas & Frios" },
            "COXAO DURO": { displayName: "Coxão duro", unit: "KG", category: "Proteínas & Frios" },
            "FIGADO": { displayName: "Fígado", unit: "KG", category: "Proteínas & Frios" },
            "COXAO MOLE": { displayName: "Coxão mole", unit: "KG", category: "Proteínas & Frios" },
            "CORACAO ALCATRA": { displayName: "Coração alcatra", unit: "KG", category: "Proteínas & Frios" },
            "MAMINHA DA ALCATRA": { displayName: "Maminha da alcatra", unit: "KG", category: "Proteínas & Frios" },
            "ACEM": { displayName: "Acém", unit: "KG", category: "Proteínas & Frios" },
            "GARGANTA SUINA": { displayName: "Garganta suína", unit: "KG", category: "Proteínas & Frios" },
            "MASCARA SUINA": { displayName: "Máscara suína", unit: "KG", category: "Proteínas & Frios" },
            "JOELHO SUINO": { displayName: "Joelho suíno", unit: "KG", category: "Proteínas & Frios" },
            "PONTA DE COSTELA": { displayName: "Ponta de costela", unit: "KG", category: "Proteínas & Frios" },
            "PATINHO CORTADO": { displayName: "Patinho cortado", unit: "KG", category: "Proteínas & Frios" },
            "CHARUTO DE CARNE MOIDA": { displayName: "Charuto de carne moída", unit: "KG", category: "Proteínas & Frios" },
            "CHARUTO DE PEITO DE FRANGO": { displayName: "Charuto de peito de frango", unit: "KG", category: "Proteínas & Frios" },

            // Laticínios
            "QUEIJO": { displayName: "Queijo", unit: "KG", category: "Laticínios" },
            "MANTEIGA": { displayName: "Manteiga", unit: "KG", category: "Laticínios" },
            "REQUEIJAO NAZZA": { displayName: "Requeijão nazza", unit: "UN", category: "Laticínios" },
            "LEITE EM PO": { displayName: "Leite em pó", unit: "KG", category: "Laticínios" },
            "CREME DE LEITE": { displayName: "Creme de leite", unit: "UN", category: "Laticínios" },
            "LEITE CONDENSADO": { displayName: "Leite condensado", unit: "UN", category: "Laticínios" },
            
            // Sacaria (Secos)
            "ARROZ BRANCO": { displayName: "Arroz branco", unit: "KG", category: "Sacaria (Secos)" },
            "ARROZ PARABOLIZADO": { displayName: "Arroz parabolizado", unit: "KG", category: "Sacaria (Secos)" },
            "MACARRAO": { displayName: "Macarrão", unit: "KG", category: "Sacaria (Secos)" },
            "OLEO": { displayName: "Óleo", unit: "L", category: "Sacaria (Secos)" },
            "ACUCAR": { displayName: "Açúcar", unit: "KG", category: "Sacaria (Secos)" },
            "FEIJAO CARIOCA": { displayName: "Feijão carioca", unit: "KG", category: "Sacaria (Secos)" },
            "FEIJAO PRETO": { displayName: "Feijão preto", unit: "KG", category: "Sacaria (Secos)" },
            "CAFE": { displayName: "Café", unit: "KG", category: "Sacaria (Secos)" },
            "FARINHA DE TRIGO": { displayName: "Farinha de trigo", unit: "KG", category: "Sacaria (Secos)" },
            "FUBA": { displayName: "Fubá", unit: "KG", category: "Sacaria (Secos)" },
            "FARINHA DE MANDIOCA": { displayName: "Farinha de mandioca", unit: "KG", category: "Sacaria (Secos)" },
            "FARINHA DE ROSCA": { displayName: "Farinha de rosca", unit: "KG", category: "Sacaria (Secos)" },
            "FEIJAO FRADINHO": { displayName: "Feijão Fradinho", unit: "KG", category: "Sacaria (Secos)" },
            "SAL FINO": { displayName: "Sal fino", unit: "KG", category: "Sacaria (Secos)" },
            "SAL GROSSO": { displayName: "Sal grosso", unit: "KG", category: "Sacaria (Secos)" },
            "TRIGO KIBE": { displayName: "Trigo Kibe", unit: "KG", category: "Sacaria (Secos)" },
            "AMIDO DE MILHO": { displayName: "Amido de milho", unit: "KG", category: "Sacaria (Secos)" },
            "ACHOCOLATADO": { displayName: "Achocolatado", unit: "KG", category: "Sacaria (Secos)" },
            
            // Mercearia (Condimentos & Conservas)
            "KETCHUP SACHE": { displayName: "Ketchup sachê", unit: "UN", category: "Mercearia" },
            "MOSTARDA SACHE": { displayName: "Mostarda sachê", unit: "UN", category: "Mercearia" },
            "MAIONESE": { displayName: "Maionese", unit: "UN", category: "Mercearia" },
            "ERVILHA": { displayName: "Ervilha", unit: "LATA", category: "Mercearia" },
            "COLORAU": { displayName: "Colorau", unit: "KG", category: "Mercearia" },
            "EXTRATO DE TOMATE": { displayName: "Extrato de tomate", unit: "LATA", category: "Mercearia" },
            "AZEITE DE OLIVA": { displayName: "Azeite de oliva", unit: "L", category: "Mercearia" },
            "VINAGRE": { displayName: "Vinagre", unit: "L", category: "Mercearia" },
            "OLEO MISTO": { displayName: "Óleo misto", unit: "L", category: "Mercearia" },
            "MOLHO DE PIMENTA": { displayName: "Molho de pimenta", unit: "UN", category: "Mercearia" },
            "AZEITONAS": { displayName: "Azeitonas", unit: "KG", category: "Mercearia" },
            "BATATA PALHA": { displayName: "Batata palha", unit: "PCTE", category: "Mercearia" },
            "MILHO EM CONSERVA": { displayName: "Milho em conserva", unit: "LATA", category: "Mercearia" },
            "ERVILHA EM CONSERVA": { displayName: "Ervilha em conserva", unit: "LATA", category: "Mercearia" },
            "LEITE DE COCO": { displayName: "Leite de coco", unit: "UN", category: "Mercearia" },
            "ADOÇANTE": { displayName: "Adoçante", unit: "UN", category: "Mercearia" },
            "CANELA EM PO": { displayName: "Canela em pó", unit: "KG", category: "Mercearia" },
            "FERMENTO BIOLOGICO": { displayName: "Fermento biológico", unit: "UN", category: "Mercearia" },
            "FERMENTO QUIMICO": { displayName: "Fermento químico", unit: "UN", category: "Mercearia" },
            "CREME DE CONFEITEIRO": { displayName: "Creme de Confeiteiro", unit: "KG", category: "Mercearia" },
            "GELATINA": { displayName: "Gelatina", unit: "UN", category: "Mercearia" },
            "DOCE EM PASTA": { displayName: "Doce em pasta", unit: "KG", category: "Mercearia" },
            
            // Bebidas
            "AGUA MINERAL": { displayName: "Água mineral", unit: "UN", category: "Bebidas" },
            "AGUA MINERAL COM GAS": { displayName: "Água mineral com gás", unit: "UN", category: "Bebidas" },
            "REFRIGERANTE SABOR GUARANA": { displayName: "Refrigerante sabor guaraná", unit: "UN", category: "Bebidas" },
            "REFRIGERANTE SABOR UVA": { displayName: "Refrigerante sabor uva", unit: "UN", category: "Bebidas" },
            "REFRIGERANTE SABOR COLA": { displayName: "Refrigerante sabor cola", unit: "UN", category: "Bebidas" },
            "REFRIGERANTE COCA COLA": { displayName: "Refrigerante coca cola", unit: "UN", category: "Bebidas" },
            "COCA COLA ZERO": { displayName: "Coca cola zero", unit: "UN", category: "Bebidas" },
            "CERVEJA IMPERIO": { displayName: "Cerveja império", unit: "UN", category: "Bebidas" },
            "CERVEJA HEINEKEN": { displayName: "Cerveja Heineken", unit: "UN", category: "Bebidas" },
            "CERVEJA STELLA": { displayName: "Cerveja Stella", unit: "UN", category: "Bebidas" },
            "RED BULL": { displayName: "Red bull", unit: "UN", category: "Bebidas" },
            "SMIRNOFF ICE": { displayName: "Smirnoff ice", unit: "UN", category: "Bebidas" },
            "KOVAK": { displayName: "Kovak", unit: "UN", category: "Bebidas" },
            "VINHO ESPUMANTE": { displayName: "Vinho Espumante", unit: "UN", category: "Bebidas" },
            "GIN": { displayName: "Gin", unit: "UN", category: "Bebidas" },
            "MONIN": { displayName: "Monin", unit: "UN", category: "Bebidas" },
            "XAROPE DE GUARANA": { displayName: "Xarope de guaraná", unit: "L", category: "Bebidas" },
            "XAROPE DE CAJU": { displayName: "Xarope de caju", unit: "L", category: "Bebidas" },
            "SUCO EM PO": { displayName: "Suco em pó", unit: "UN", category: "Bebidas" },
            "GATORADE": { displayName: "Gatorade", unit: "UN", category: "Bebidas" },
            "GUARACAMP": { displayName: "Guaracamp", unit: "UN", category: "Bebidas" },
            
            // Congelados & Padaria
            "MASSA DE PASTEL": { displayName: "Massa de Pastel", unit: "KG", category: "Congelados & Padaria" },
            "HAMBURGUER": { displayName: "Hambúrguer", unit: "UN", category: "Congelados & Padaria" },
            "BATATA FRITA": { displayName: "Batata frita", unit: "KG", category: "Congelados & Padaria" },
            "PAO DE QUEIJO": { displayName: "Pão de queijo", unit: "KG", category: "Congelados & Padaria" },
            "KIBE": { displayName: "Kibe", unit: "KG", category: "Congelados & Padaria" },
            "BOLINHA DE QUEIJO": { displayName: "Bolinha de queijo", unit: "KG", category: "Congelados & Padaria" },
            "SALGADINHO DE AIPIM": { displayName: "Salgadinho de aipim", unit: "KG", category: "Congelados & Padaria" },
            "COXINHA": { displayName: "Coxinha", unit: "KG", category: "Congelados & Padaria" },
            "RISOLE DE CAMARAO": { displayName: "Risole de camarão", unit: "KG", category: "Congelados & Padaria" },
            
            // Snacks
            "MARIOLA": { displayName: "Mariola", unit: "UN", category: "Snacks" },
            "AMENDOIM": { displayName: "Amendoim", unit: "KG", category: "Snacks" },
            "ROSQUINHA MABEL": { displayName: "Rosquinha Mabel", unit: "PCTE", category: "Snacks" },
            "PACOCA": { displayName: "Paçoca", unit: "UN", category: "Snacks" },
            "GELEIA DE MOCOTO": { displayName: "Geleia de mocotó", unit: "UN", category: "Snacks" },
            "SEQUILHOS": { displayName: "Sequilhos", unit: "PCTE", category: "Snacks" },
            "PIT STOP": { displayName: "Pit Stop", unit: "PCTE", category: "Snacks" },
            "ATIVPLUS": { displayName: "AtivPlus", unit: "UN", category: "Snacks" },
            "BISCOITO TUCS": { displayName: "Biscoito Tucs", unit: "PCTE", category: "Snacks" },
            "BISCOITO PASSATEMPO": { displayName: "Biscoito passatempo", unit: "PCTE", category: "Snacks" },
            "BISCOITO AMANTEIGADO": { displayName: "Biscoito amanteigado", unit: "PCTE", category: "Snacks" },
            "AMANTEIGADO GOIABINHA": { displayName: "Amanteigado Goiabinha", unit: "PCTE", category: "Snacks" },
            "BARRINHA DE RACAO": { displayName: "Barrinha de ração", unit: "UN", category: "Snacks" },
            "RAPADURA": { displayName: "Rapadura", unit: "UN", category: "Snacks" },
            
            // Outros
            "GELO": { displayName: "Gelo", unit: "SACO", category: "Outros" }
        };

        function getMaterialCategory(materialName) {
            // Normaliza o nome do material para a busca
            const upperMaterial = materialName.toUpperCase().trim();
            // Tenta encontrar pelo nome de exibição (ex: "Batatas")
            if (masterMaterialList[upperMaterial]) {
                 return masterMaterialList[upperMaterial].category;
            }
            
            // Fallback: Tenta encontrar pela chave (ex: "BATATAS")
            const foundKey = Object.keys(masterMaterialList).find(key => 
                masterMaterialList[key].displayName.toUpperCase() === upperMaterial
            );
            
            return foundKey ? masterMaterialList[foundKey].category : "Outros";
        }
        // --- FIM: LÓGICA DE CATEGORIZAÇÃO E LISTA MESTRA ---

        function renderData(selectedDate) {
            logTableBody.innerHTML = '';
            analysisOutput.innerHTML = '';
            const filtered = allDepartures.filter(d => d.date === selectedDate);
            if (filtered.length === 0) {
                logTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-gray-500">Nenhuma saída registrada para ${selectedDate}.</td></tr>`; 
            } else {
                logTableBody.innerHTML = filtered.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0))
                .map((item) => {
                    const time = item.timestamp?.toDate ? item.timestamp.toDate().toLocaleTimeString('pt-BR') : 'N/A';
                    return `<tr class="data-row">
                                <td class="text-sm text-gray-600">${time}</td>
                                <td class="text-sm font-medium text-gray-900">${item.material}</td>
                                <td class="text-sm text-gray-500">${item.unit_of_measure || 'N/A'}</td>
                                <td class="text-sm text-blue-600 font-semibold">${item.quantity}</td>
                                <td class="text-sm text-gray-500">${item.destination || 'N/A'}</td>
                                <td class="text-sm text-gray-500">${item.userEmail ? item.userEmail.split('@')[0] : ''}</td>
                                <td><button onclick="deleteDeparture('${item.id}', '${item.material}')" class="p-1 rounded-full text-red-500 hover:bg-red-100" title="Excluir"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button></td>
                            </tr>`;
                }).join('');
            }
            calculateSummary(filtered, summaryTableBody);
        }
        
        // --- FUNÇÃO ATUALIZADA PARA CATEGORIAS ---
        function renderWeeklySummary() {
            const yearMonth = weekMonthFilterInput.value;
            const weekNumber = weekNumberFilterInput.value;
            if (!yearMonth || !weekNumber) return;
            
            const dateRange = getWeekOfMonthDateRange(yearMonth, weekNumber);
            const filtered = allDepartures.filter(d => d.date >= dateRange.start && d.date <= dateRange.end);
            
            weeklySummaryTableBody.innerHTML = ''; // Limpa a tabela

            if (filtered.length === 0) {
                weeklySummaryTableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-500">Nenhum dado para este período.</td></tr>`;
                return;
            }

            // 1. Agrega os dados por categoria e depois por material
            const summaryByCategory = {};
            filtered.forEach(item => {
                // Usa a nova função para obter a categoria
                const category = getMaterialCategory(item.material);
                const key = `${item.material}|${item.unit_of_measure || 'UNID'}`;
                
                if (!summaryByCategory[category]) {
                    summaryByCategory[category] = {};
                }
                if (!summaryByCategory[category][key]) {
                    summaryByCategory[category][key] = 0;
                }
                summaryByCategory[category][key] += item.quantity;
            });

            // 2. Renderiza a tabela com os grupos
            const sortedCategories = Object.keys(summaryByCategory).sort();
            
            sortedCategories.forEach(category => {
                // Adiciona a linha de cabeçalho da categoria
                weeklySummaryTableBody.innerHTML += `
                    <tr class="bg-gray-100 sticky top-0">
                        <td colspan="3" class="text-sm font-bold text-gray-800 py-2 px-4">${category}</td>
                    </tr>
                `;
                
                // Adiciona as linhas de material para esta categoria
                const sortedMaterials = Object.keys(summaryByCategory[category]).sort();
                sortedMaterials.forEach(key => {
                    const [material, unit] = key.split('|');
                    const quantity = summaryByCategory[category][key];
                    weeklySummaryTableBody.innerHTML += `
                        <tr class="data-row">
                            <td class="text-base font-semibold text-gray-900 pl-8">${material}</td>
                            <td class="text-sm text-gray-500">${unit}</td>
                            <td class="text-base font-bold text-blue-600">${quantity.toFixed(2)}</td>
                        </tr>
                    `;
                });
            });
        }
        
        function renderMonthlySummary() {
            const yearMonth = monthFilterInput.value;
            if (!yearMonth) return;
            
            // 1. Filtra dados para o mês selecionado
            const filtered = allDepartures.filter(d => d.date && d.date.startsWith(yearMonth));
            
            // 2. Renderiza a tabela de resumo principal (como antes)
            calculateSummary(filtered, monthlySummaryTableBody);

            // --- 3. NOVA ANÁLISE DE DESTAQUES DO MÊS ---
            const highlightsOutput = document.getElementById('top-month-output'); // Elemento de saída
            if (filtered.length === 0) {
                highlightsOutput.innerHTML = '<p class="text-gray-500">Nenhum dado para analisar.</p>';
                return;
            }

            // 3a. Encontrar Material com Maior Saída (Top Material)
            const materialSummary = {};
            filtered.forEach(item => {
                const key = `${item.material}|${item.unit_of_measure || 'UNID'}`;
                materialSummary[key] = (materialSummary[key] || 0) + item.quantity;
            });

            let topMaterial = { name: 'N/A', unit: '', quantity: 0 };
            for (const key in materialSummary) {
                if (materialSummary[key] > topMaterial.quantity) {
                    const [name, unit] = key.split('|');
                    topMaterial = { name, unit: `(${unit})`, quantity: materialSummary[key] };
                }
            }

            // 3b. Encontrar Dia com Maior Saída (Top Day)
            const dailySummary = {};
            filtered.forEach(item => {
                dailySummary[item.date] = (dailySummary[item.date] || 0) + item.quantity;
            });

            let topDay = { date: 'N/A', quantity: 0 };
            for (const date in dailySummary) {
                if (dailySummary[date] > topDay.quantity) {
                    topDay = { date, quantity: dailySummary[date] };
                }
            }
            // Formatar a data (ex: 2023-10-25 -> 25/10/2023)
            let formattedDate = 'N/A';
            if (topDay.date !== 'N/A') {
                const [year, month, day] = topDay.date.split('-');
                formattedDate = `${day}/${month}/${year}`;
            }

            // 3c. Renderizar no HTML
            highlightsOutput.innerHTML = `
                <div class="text-left space-y-4 w-full">
                    <div>
                        <p class="text-sm font-semibold text-blue-600">MATERIAL DE MAIOR SAÍDA</p>
                        <p class="text-2xl font-bold text-gray-800">${topMaterial.name} <span class="text-base font-normal text-gray-500">${topMaterial.unit}</span></p>
                        <p class="text-lg text-gray-600">Total: <span class="font-bold">${topMaterial.quantity.toFixed(2)}</span></p>
                    </div>
                    <div class="border-t pt-4">
                        <p class="text-sm font-semibold text-blue-600">DIA DE MAIOR SAÍDA</p>
                        <p class="text-2xl font-bold text-gray-800">${formattedDate}</p>
                        <p class="text-lg text-gray-600">Total: <span class="font-bold">${topDay.quantity.toFixed(2)}</span> itens</p>
                    </div>
                </div>
            `;
        }
        
        function calculateSummary(filteredData, tableBody) {
            tableBody.innerHTML = '';
            const summary = {};
            filteredData.forEach(item => {
                const key = `${item.material}|${item.unit_of_measure || 'UNID'}`;
                summary[key] = (summary[key] || 0) + item.quantity;
            });
            const keys = Object.keys(summary).sort();
            if (keys.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-500">Nenhum dado para este período.</td></tr>`;
                return;
            }
            tableBody.innerHTML = keys.map(key => {
                const [material, unit] = key.split('|');
                return `
                    <tr class="data-row">
                        <td class="text-base font-semibold text-gray-900">${material}</td>
                        <td class="text-sm text-gray-500">${unit}</td>
                        <td class="text-base font-bold text-blue-600">${summary[key].toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
        }
        
        const generateAnalysis = async () => {
             const tableRows = summaryTableBody.children;
            if (tableRows.length === 0 || (tableRows.length === 1 && tableRows[0].children[0].colSpan === 3)) {
                analysisOutput.innerHTML = '<p class="text-red-600 font-semibold">ERRO: Sem dados para analisar no dia selecionado.</p>';
                return;
            }
            analysisOutput.innerHTML = '<p class="text-blue-600 font-semibold animate-pulse">Processando relatório...</p>';
            let data = Array.from(tableRows).map(row => `${row.children[0].textContent} (${row.children[1].textContent}): ${row.children[2].textContent}`);
            const userQuery = `Analise a seguinte lista de consumo diário e gere um breve relatório para o Gerente de Logística. Destaque os 3 itens de maior consumo e forneça uma sugestão de ação (ex: 'Monitorar estoque'). Lista: ${data.join('; ')}`;
            const systemPrompt = "Você é um Analista Logístico de IA. Sua resposta deve ser um 'STATUS REPORT' formal em português. Use Markdown (negrito e listas).";
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Falha ao gerar análise.";
                analysisOutput.innerHTML = `<div class="p-4 bg-gray-50 border border-gray-200 mt-4 text-sm whitespace-pre-wrap rounded-lg">${text}</div>`;
            } catch (error) {
                analysisOutput.innerHTML = '<p class="text-red-600 font-semibold">ERRO DE COMUNICAÇÃO: Verifique a conexão.</p>';
            }
        };
        window.generateAnalysis = generateAnalysis;

        // --- FUNÇÃO ATUALIZADA PARA VALIDAÇÃO ---
        async function processTextData(text, dateForBatch) {
            const lines = text.split('\n');
            let successCount = 0, errorCount = 0, errorLines = [];
            for (const [index, line] of lines.entries()) {
                const trimmedLine = line.trim();
                if (!trimmedLine) continue;
                
                const parts = trimmedLine.split(/\s+/).filter(Boolean);
                if (parts.length < 3) {
                    errorCount++; errorLines.push(index + 1); continue; 
                }
                
                // A lógica de extração mudou ligeiramente para ser mais robusta
                const destination = parts.length > 3 ? parts.pop() : 'COZINHA';
                let quantityStr = parts.pop();
                parts.pop(); // Descarta a unidade do arquivo, pois usaremos a predefinida
                const materialNameFromFile = parts.join(' ');
                
                // Validação contra a Lista Mestra
                const materialKey = materialNameFromFile.toUpperCase().trim();
                const materialData = masterMaterialList[materialKey];
                
                if (!materialData) {
                    // Se o material não for encontrado na lista mestra
                    errorCount++; errorLines.push(index + 1); continue;
                }
                
                // Pega a unidade predefinida da lista mestra
                const predefinedUnit = materialData.unit;
                
                if (quantityStr.includes('/')) quantityStr = quantityStr.split('/')[0].trim();
                if (quantityStr.includes('½')) quantityStr = "0.5";
                const quantity = parseFloat(quantityStr.replace(',', '.'));
                
                if (isNaN(quantity)) {
                    errorCount++; errorLines.push(index + 1); continue;
                }
                
                // Registra usando o nome de exibição e a unidade predefinida
                const success = await registerDeparture(materialData.displayName, quantity, dateForBatch, destination, predefinedUnit);
                if (success) successCount++;
                else { errorCount++; errorLines.push(index + 1); }
            }
            let summaryMessage = `<p class="text-green-600 font-semibold">${successCount} registros importados com sucesso.</p>`;
            if (errorCount > 0) summaryMessage += `<p class="text-red-600 font-semibold">${errorCount} linhas com formato inválido ou material não cadastrado foram ignoradas. Linhas: ${errorLines.join(', ')}</p>`;
            if (successCount === 0 && errorCount === 0) summaryMessage = `<p class="text-yellow-600 font-semibold">Nenhum dado válido para importação foi encontrado.</p>`;
            batchUploadStatus.innerHTML = summaryMessage;
        }


        const handleFileUpload = async () => {
            const fileInput = document.getElementById('word-file-input');
            const file = fileInput.files[0];
            const dateForBatch = document.getElementById('date').value;
            if (!file || !dateForBatch) {
                batchUploadStatus.innerHTML = `<p class="text-red-600 font-semibold">ERRO: Selecione um arquivo e a data da operação.</p>`;
                return;
            }
            batchUploadStatus.innerHTML = '<p class="text-blue-600 font-semibold animate-pulse">Processando arquivo...</p>';
            const reader = new FileReader();
            if (file.name.endsWith('.docx')) {
                reader.onload = async (e) => {
                    try {
                        const res = await mammoth.extractRawText({ arrayBuffer: e.target.result });
                        await processTextData(res.value, dateForBatch);
                    } catch (err) { batchUploadStatus.innerHTML = '<p class="text-red-600 font-semibold">ERRO: Falha ao ler .docx.</p>'; }
                };
                reader.readAsArrayBuffer(file);
            } else if (file.name.endsWith('.txt')) {
                reader.onload = async (e) => {
                    try { await processTextData(e.target.result, dateForBatch); } 
                    catch (err) { batchUploadStatus.innerHTML = '<p class="text-red-600 font-semibold">ERRO: Falha ao ler .txt.</p>';}
                };
                reader.readAsText(file);
            } else {
                 batchUploadStatus.innerHTML = '<p class="text-red-600 font-semibold">ERRO: Tipo de arquivo não suportado.</p>';
            }
        };
        window.handleFileUpload = handleFileUpload;

        // --- NOVAS FUNÇÕES PARA O FORMULÁRIO DE REGISTRO ---

        // Preenche o <select> de materiais
        function populateMaterialSelector() {
            // Ordena os materiais pelo nome de exibição
            const sortedMaterials = Object.keys(masterMaterialList).sort((a, b) => 
                masterMaterialList[a].displayName.localeCompare(masterMaterialList[b].displayName)
            );

            // Adiciona <option> para cada material
            sortedMaterials.forEach(key => {
                const material = masterMaterialList[key];
                const option = document.createElement('option');
                option.value = key; // O valor é a CHAVE (ex: "CEBOLA")
                option.textContent = material.displayName; // O texto é o Nome de Exibição (ex: "Cebola")
                materialInput.appendChild(option);
            });
        }

        // Chamado quando o usuário seleciona um material no <select>
        function handleMaterialChange(e) {
            const selectedKey = e.target.value;
            if (selectedKey && masterMaterialList[selectedKey]) {
                // Encontra a unidade predefinida e atualiza o input de unidade
                unitInput.value = masterMaterialList[selectedKey].unit;
            } else {
                // Limpa se o usuário selecionar "Selecione um material..."
                unitInput.value = '';
            }
        }
        
        // Adiciona o listener ao <select> de materiais
        materialInput.addEventListener('change', handleMaterialChange);

        // Inicializa o seletor de materiais quando a janela carregar
        window.onload = populateMaterialSelector;

    </script>
</head>
<body>
    
    <div id="loading-indicator" class="fixed inset-0 bg-gray-100/50 flex justify-center items-center z-50 backdrop-blur-sm">
        <p class="text-blue-600 font-semibold text-lg">Carregando Sistema...</p>
    </div>

    <div id="auth-container">
        <div id="auth-card" class="max-w-md w-full p-8 md:p-10">
            <!-- Container do Login -->
            <div id="login-form-container">
                <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Controle de Estoque</h1>
                <p class="text-center text-gray-500 mb-6">Por favor, insira suas credenciais para continuar.</p>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="login-email" required class="mt-1 block w-full p-3">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Senha</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full p-3">
                    </div>
                    <button type="submit" class="w-full action-button py-3 px-6 text-base">Entrar</button>
                </form>
                <p class="mt-6 text-center text-sm text-gray-600">
                    Não tem uma conta? <button onclick="toggleAuthForms()" class="font-semibold text-blue-600 hover:underline">Cadastre-se</button>
                </p>
            </div>
            <!-- Container do Cadastro -->
            <div id="register-form-container" class="hidden">
                <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Criar Nova Conta</h1>
                 <p class="text-center text-gray-500 mb-6">Preencha os campos para se registrar.</p>
                <form id="register-form" class="space-y-6">
                    <div>
                        <label for="register-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="register-email" required class="mt-1 block w-full p-3">
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-700">Senha (mín. 6 caracteres)</label>
                        <input type="password" id="register-password" required class="mt-1 block w-full p-3">
                    </div>
                    <button type="submit" class="w-full action-button py-3 px-6 text-base">Registrar</button>
                </form>
                <p class="mt-6 text-center text-sm text-gray-600">
                    Já tem uma conta? <button onclick="toggleAuthForms()" class="font-semibold text-blue-600 hover:underline">Faça o login</button>
                </p>
            </div>
            <div id="auth-status" class="mt-4"></div>
        </div>
    </div>


    <div id="main-app-container" class="hidden p-4 sm:p-8 w-full">
        <div class="max-w-7xl mx-auto">
            <header class="mb-8 flex flex-col sm:flex-row justify-between sm:items-center">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">
                        CONTROLE DE ESTOQUE
                    </h1>
                    <p id="user-id-display" class="text-sm text-gray-500"></p>
                </div>
                <button id="logout-button" class="mt-4 sm:mt-0 secondary-button text-sm font-medium py-2 px-4 rounded-lg transition duration-200">Sair</button>
            </header>

            <!-- PAINEL DE NAVEGAÇÃO (DASHBOARD) -->
            <div id="dashboard-container" class="">
                 <h2 class="text-2xl font-semibold text-gray-800 mb-6">Painel Principal</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                       <!-- Card 1: Registrar Saídas -->
                       <div onclick="showRegistro()" class="dashboard-card cursor-pointer p-6 content-container flex flex-col items-center text-center">
                           <div class="bg-blue-100 p-3 rounded-full mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg></div>
                           <h3 class="text-lg font-bold text-gray-800 mb-2">Registrar Saídas</h3>
                           <p class="text-sm text-gray-500">Lance as saídas de material, manual ou em lote.</p>
                       </div>
                       <!-- Card 2: Relatório Diário -->
                       <div onclick="showRelatorios()" class="dashboard-card cursor-pointer p-6 content-container flex flex-col items-center text-center">
                           <div class="bg-green-100 p-3 rounded-full mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg></div>
                           <h3 class="text-lg font-bold text-gray-800 mb-2">Relatório Diário</h3>
                           <p class="text-sm text-gray-500">Visualize logs e resumos de consumo do dia.</p>
                       </div>
                        <!-- Card 3: Análise Semanal -->
                       <div onclick="showSemanal()" class="dashboard-card cursor-pointer p-6 content-container flex flex-col items-center text-center">
                           <div class="bg-yellow-100 p-3 rounded-full mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></div>
                           <h3 class="text-lg font-bold text-gray-800 mb-2">Análise Semanal</h3>
                           <p class="text-sm text-gray-500">Consulte o consumo total por semana de um mês.</p>
                       </div>
                        <!-- Card 4: Análise Mensal -->
                       <div onclick="showMensal()" class="dashboard-card cursor-pointer p-6 content-container flex flex-col items-center text-center">
                           <div class="bg-purple-100 p-3 rounded-full mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg></div>
                           <h3 class="text-lg font-bold text-gray-800 mb-2">Análise Mensal</h3>
                           <p class="text-sm text-gray-500">Veja o consumo total por mês e o pico de demanda.</p>
                       </div>
                 </div>
            </div>

            <!-- SEÇÃO DE REGISTRO (Oculta) -->
            <div id="registro-container" class="hidden">
                 <button onclick="showDashboard()" class="secondary-button mb-6 font-semibold py-2 px-4 rounded-lg flex items-center text-sm"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>Voltar ao Painel</button>
                 <h2 class="text-2xl font-semibold text-gray-800 mb-6">Registrar Saídas</h2>
                <div class="p-6 md:p-8 mb-8 content-container">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-3">Registro Manual</h3>
                    <form id="add-departure-form" class="space-y-6 pt-4"> 
                        <div>
                             <label for="material-name" class="block text-sm font-medium text-gray-700">1. Nome do Material</label>
                             <!-- ATUALIZADO: De <input> para <select> -->
                             <select id="material-name" name="material-name" required class="mt-1 block w-full p-3">
                                <option value="" disabled selected>Selecione um material...</option>
                                <!-- Opções serão preenchidas pelo JS -->
                             </select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="quantity" class="block text-sm font-medium text-gray-700">2. Quantidade</label>
                                <input type="number" id="quantity" name="quantity" step="0.01" required min="0.01" placeholder="Ex: 1.5" class="mt-1 block w-full p-3">
                            </div>
                            <div>
                                <label for="unit_of_measure" class="block text-sm font-medium text-gray-700">3. Unidade de Medida</label>
                                <!-- ATUALIZADO: Agora é readonly e preenchido automaticamente -->
                                <input type="text" id="unit_of_measure" name="unit_of_measure" required placeholder="Selecione um material" class="mt-1 block w-full p-3 uppercase bg-gray-200" readonly>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-700">4. Data da Saída</label>
                                <input type="date" id="date" required class="mt-1 block w-full p-3">
                            </div>
                            <div>
                                <label for="destination" class="block text-sm font-medium text-gray-700">5. Destino</label>
                                <input type="text" id="destination" name="destination" required value="COZINHA" placeholder="Ex: Cozinha Principal" class="mt-1 block w-full p-3">
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center pt-4">
                            <button type="submit" class="w-full sm:w-auto action-button font-medium py-3 px-8">Executar Registro</button>
                            <p id="form-status" class="text-sm mt-3 sm:mt-0 sm:ml-4 font-semibold"></p>
                        </div>
                    </form>
                </div>
                <div class="p-6 md:p-8 mb-8 content-container">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-3">Registro em Lote</h3>
                    <div class="bg-gray-50 p-4 border border-dashed border-gray-300 mb-4 text-sm rounded-lg mt-4">
                        <h4 class="font-semibold text-gray-800">Instruções:</h4>
                        <!-- ATUALIZADO: Instrução de upload simplificada -->
                        <p class="mt-2 text-gray-600">Crie um arquivo (.docx ou .txt) com as colunas na ordem: <code class="bg-gray-200 p-1 font-mono text-xs rounded">MATERIAL [UNIDADE - será ignorada] QUANTIDADE [DESTINO - opcional]</code></p>
                        <p class="mt-2 text-gray-600"><strong>Importante:</strong> A Unidade de Medida será puxada automaticamente do cadastro. O Destino padrão é "COZINHA".</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center pt-4">
                        <div>
                            <label for="word-file-input" class="block text-sm font-medium text-gray-700 mb-1">Arquivo de dados</label>
                            <input type="file" id="word-file-input" accept=".docx,.txt" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-gray-200 file:text-gray-700 hover:file:bg-gray-300 cursor-pointer">
                        </div>
                        <div class="self-end">
                             <button onclick="handleFileUpload()" class="w-full action-button font-medium py-3 px-8">Processar Arquivo</button>
                        </div>
                    </div>
                     <div id="batch-upload-status" class="mt-4 text-sm font-semibold"></div>
                </div>
            </div>

            <!-- SEÇÃO DE RELATÓRIOS (Oculta) -->
            <div id="relatorios-container" class="hidden">
                 <button onclick="showDashboard()" class="secondary-button mb-6 font-semibold py-2 px-4 rounded-lg flex items-center text-sm"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>Voltar ao Painel</button>
                 <h2 class="text-2xl font-semibold text-gray-800 mb-6">Relatório Diário</h2>
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <div class="lg:col-span-3 p-6 content-container">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-3">Log de Transações</h3>
                        <div class="my-4">
                            <label for="date-filter" class="block text-sm font-medium text-gray-700">Selecionar Data:</label>
                            <input type="date" id="date-filter" class="mt-1 block w-full p-2">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead><tr><th>Hora</th><th>Material</th><th>Unid.</th><th>Qtd.</th><th>Destino</th><th>Por</th><th>Ações</th></tr></thead>
                                <tbody id="log-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="lg:col-span-2 p-6 content-container">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-3">Resumo do Dia</h3>
                        <div class="overflow-x-auto my-4">
                            <table class="min-w-full">
                                <thead><tr><th>Material</th><th>Unid.</th><th>Total</th></tr></thead>
                                <tbody id="summary-table-body"></tbody>
                            </table>
                        </div>
                        <div class="mt-6 border-t pt-4">
                            <button onclick="generateAnalysis()" class="w-full action-button text-sm font-medium py-3 px-4">Gerar Análise (IA) ✨</button>
                            <div id="analysis-output" class="mt-4 text-gray-600"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SEÇÃO SEMANAL (Oculta) -->
            <div id="semanal-container" class="hidden">
                <button onclick="showDashboard()" class="secondary-button mb-6 font-semibold py-2 px-4 rounded-lg flex items-center text-sm"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>Voltar ao Painel</button>
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Análise

