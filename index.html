<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Di√°rio de Sa√≠da de Materiais</title>
    <!-- Carregando Tailwind CSS para estiliza√ß√£o -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Estilos para a tabela */
        th, td {
            padding: 12px 16px;
            text-align: left;
        }
        th {
            background-color: #3f51b5;
            color: white;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
        .data-row:nth-child(even) {
            background-color: #e8eaf6;
        }
        .data-row:hover {
            background-color: #c5cae9;
        }
        .container-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
    <!-- Importando Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Vari√°veis globais do ambiente Canvas
        setLogLevel('Debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const canvasFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // üö® PASSO CR√çTICO PARA USO EXTERNO (GitHub Pages, etc.) üö®
        // Suas chaves do Firebase foram inseridas abaixo.
        const userFirebaseConfig = {
            apiKey: "AIzaSyAd6tEf3dBDohA1TCgLn-w4UW1UKE_90tE",
            authDomain: "meu-controle-de-estoque-3344f.firebaseapp.com",
            projectId: "meu-controle-de-estoque-3344f",
            storageBucket: "meu-controle-de-estoque-3344f.firebasestorage.app",
            messagingSenderId: "524659153893",
            appId: "1:524659153893:web:118326d46946ee60306d0c"
        };
        // -------------------------------------------------------------

        let firebaseConfig = {};
        
        const IS_USING_PLACEHOLDERS = userFirebaseConfig.projectId === "APENAS_COLE_SUA_CHAVE_AQUI";

        // Determinar qual configura√ß√£o usar
        if (Object.keys(canvasFirebaseConfig).length > 0) {
            // 1. Usar a configura√ß√£o do Canvas se estiver dispon√≠vel
            firebaseConfig = canvasFirebaseConfig;
        } else if (!IS_USING_PLACEHOLDERS) {
            // 2. Usar a configura√ß√£o manual se o usu√°rio a preencheu
            firebaseConfig = userFirebaseConfig;
            console.log("Usando configura√ß√£o manual do Firebase.");
        } else {
            // 3. Configura√ß√£o ausente: Bloquear a execu√ß√£o.
            const errorMsg = "ERRO: Configura√ß√£o do Firebase ausente. Por favor, edite o c√≥digo e preencha suas chaves.";
            console.error(errorMsg);
            document.body.innerHTML = `<div class='p-8 text-center text-red-600 font-semibold'>${errorMsg}</div>`;
            // return; // Linha que causava SyntaxError: removida e substitu√≠da por bloco condicional abaixo
        }

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let allDepartures = []; 

        // Define a cole√ß√£o para este aplicativo.
        // Se estiver rodando fora do Canvas (Sem a config Canvas), usa-se 'daily_departures_data' na raiz.
        const collectionPath = (Object.keys(canvasFirebaseConfig).length > 0) ? 
            `artifacts/${appId}/public/data/daily_departures` : 
            'daily_departures_data';
        
        // Refer√™ncias do DOM
        const logTableBody = document.getElementById('log-table-body');
        const summaryTableBody = document.getElementById('summary-table-body');
        const dateFilterInput = document.getElementById('date-filter');
        const materialInput = document.getElementById('material-name');
        const formStatus = document.getElementById('form-status');
        const loadingIndicator = document.getElementById('loading-indicator');
        const userIdDisplay = document.getElementById('user-id-display');
        const addDepartureForm = document.getElementById('add-departure-form'); 
        const externalConfigWarning = document.getElementById('external-config-warning');

        // Material List Suggestions (Based on user's previous context)
        const materialSuggestions = [
            "Cebola", "Batatas", "Ab√≥bora", "Tomate", "Piment√£o", "Cheiro verde", "Beterraba", 
            "Pepino", "Repolho", "Alho", "Melancia", "Lim√£o", "Laranja", "Mam√£o", "Mel√£o", "Ma√ß√£",
            "√Ågua mineral", "Refrigerante sabor guaran√°", "Refrigerante sabor uva", "Ovo", 
            "Salsicha", "Queijo", "Presunto", "Mortadela", "Peixe", "Peito de frango", "Patinho",
            "Arroz branco", "Macarr√£o", "√ìleo", "A√ß√∫car", "Feij√£o carioca", "Caf√©", "Farinha de trigo", 
            "Ketchup sach√™", "Mostarda sach√™", "Maionese", "Sal fino", "Extrato de tomate", "Creme de leite",
            "Leite condensado", "Achocolatado"
        ];
        
        // Fun√ß√£o para preencher a lista de sugest√µes (datalist)
        function fillMaterialDatalist() {
            const datalist = document.getElementById('material-suggestions');
            if (datalist) {
                materialSuggestions.forEach(material => {
                    const option = document.createElement('option');
                    option.value = material;
                    datalist.appendChild(option);
                });
            }
        }

        // --- 1. Inicializa√ß√£o do Firebase e Autentica√ß√£o ---
        
        // Novo bloco condicional que s√≥ inicializa o Firebase se a configura√ß√£o for v√°lida.
        if (!IS_USING_PLACEHOLDERS || Object.keys(canvasFirebaseConfig).length > 0) {
            
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Se estiver usando a configura√ß√£o manual, exibe um aviso (apenas se a configura√ß√£o for preenchida)
            if (externalConfigWarning && !Object.keys(canvasFirebaseConfig).length && !IS_USING_PLACEHOLDERS) {
                externalConfigWarning.classList.remove('hidden');
            }


            // Listener de autentica√ß√£o
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    // Tenta autenticar anonimamente, que √© o modo de opera√ß√£o para este app simples.
                    try {
                        // O signInWithCustomToken √© relevante apenas dentro do Canvas, mas mantido por seguran√ßa.
                        if (initialAuthToken && Object.keys(canvasFirebaseConfig).length > 0) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                        userId = auth.currentUser.uid;
                    } catch (error) {
                        console.error("Erro fatal de autentica√ß√£o (verifique as regras do Auth/Firestore):", error);
                        // O erro de autentica√ß√£o pode ser causado por regras de seguran√ßa do Auth.
                    }
                }
                
                if (userIdDisplay) {
                    if (userId) {
                        userIdDisplay.textContent = `ID do Usu√°rio: ${userId}`;
                    } else {
                        userIdDisplay.textContent = `Falha ao autenticar.`;
                    }
                }
                
                isAuthReady = true;
                if(loadingIndicator) loadingIndicator.classList.add('hidden');
                setupRealtimeListener();

                // Adiciona o listener do formul√°rio ap√≥s a autentica√ß√£o
                if(addDepartureForm) {
                    addDepartureForm.addEventListener('submit', addDeparture);
                }
            });
        }


        // --- 2. Funcionalidade de Adicionar Sa√≠da ---
        const addDeparture = async (event) => { 
            event.preventDefault();
            
            if (!isAuthReady || !userId) {
                formStatus.textContent = "Aguardando autentica√ß√£o...";
                return;
            }

            const material = materialInput.value.trim();
            // Garante que a convers√£o para n√∫mero seja robusta
            const quantity = parseFloat(document.getElementById('quantity').value.trim().replace(',', '.')); 
            const date = document.getElementById('date').value.trim();

            if (!material || isNaN(quantity) || quantity <= 0 || !date) {
                formStatus.textContent = "Por favor, preencha todos os campos corretamente (Qtd. deve ser um n√∫mero).";
                formStatus.classList.remove('text-green-600');
                formStatus.classList.add('text-red-600');
                return;
            }

            try {
                // Adiciona o documento √† cole√ß√£o
                await addDoc(collection(db, collectionPath), {
                    material: material,
                    quantity: quantity,
                    date: date, // Data formatada como YYYY-MM-DD
                    timestamp: serverTimestamp(),
                    userId: userId 
                });

                formStatus.textContent = "Sa√≠da registrada com sucesso!";
                formStatus.classList.remove('text-red-600');
                formStatus.classList.add('text-green-600');
                
                // Limpar o formul√°rio (mant√©m a data e o material para registro r√°pido)
                document.getElementById('quantity').value = '';
                materialInput.value = '';
                materialInput.focus();

            } catch (e) {
                console.error("Erro ao adicionar documento: ", e);
                // Mensagem de erro expl√≠cita sobre a causa mais prov√°vel: Regras de Seguran√ßa.
                formStatus.textContent = "Erro ao registrar. üõë Verifique as Regras de Seguran√ßa do Firestore no console do Firebase.";
                formStatus.classList.remove('text-green-600');
                formStatus.classList.add('text-red-600');
            }
        };

        // --- 3. Listener em Tempo Real (onSnapshot) ---
        function setupRealtimeListener() {
            if (!db) return;

            // Define a data atual como filtro padr√£o
            const today = new Date().toISOString().split('T')[0];
            if (dateFilterInput && !dateFilterInput.value) { 
                dateFilterInput.value = today;
            }
            
            const q = query(collection(db, collectionPath));
            
            onSnapshot(q, (querySnapshot) => {
                if (!isAuthReady) return; 

                const departures = [];
                querySnapshot.forEach((doc) => {
                    departures.push({ id: doc.id, ...doc.data() });
                });
                
                // Armazena os dados brutos
                allDepartures = departures;

                // Renderiza com base na data selecionada
                const selectedDate = dateFilterInput.value;
                renderData(allDepartures, selectedDate);
            }, (error) => {
                console.error("Erro ao ouvir dados:", error);
                // Mensagem de erro expl√≠cita sobre a causa mais prov√°vel: Regras de Seguran√ßa.
                if(logTableBody) logTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-600 font-semibold">ERRO: Falha ao carregar dados. Verifique as Regras de Seguran√ßa do Firestore!</td></tr>`;
                if(summaryTableBody) summaryTableBody.innerHTML = `<tr><td colspan="2" class="text-center py-4 text-red-600 font-semibold">ERRO: Falha ao carregar dados.</td></tr>`;
            });
        }
        
        // Listener para o filtro de data: Re-renderiza usando os dados em cache (allDepartures)
        if(dateFilterInput) {
            dateFilterInput.addEventListener('change', () => {
                if(isAuthReady) {
                    const selectedDate = dateFilterInput.value;
                    renderData(allDepartures, selectedDate);
                }
            });
        }

        // --- 4. Renderiza√ß√£o dos Dados e Resumo ---
        function renderData(departures, selectedDate) {
            if(logTableBody) logTableBody.innerHTML = '';
            
            // 1. Filtrar as sa√≠das pela data selecionada
            const filteredDepartures = departures.filter(d => d.date === selectedDate);
            
            // 2. Renderizar o Log Completo
            if (filteredDepartures.length === 0) {
                if(logTableBody) logTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">Nenhuma sa√≠da registrada para ${selectedDate}.</td></tr>`;
            } else {
                filteredDepartures
                    // Sort by timestamp (descending) to show newest first
                    .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0))
                    .forEach((item) => {
                    const row = document.createElement('tr');
                    row.classList.add('data-row');
                    
                    const time = item.timestamp?.toDate ? item.timestamp.toDate().toLocaleTimeString('pt-BR') : 'N/A';
                    // Use toFixed(2) para garantir que a quantidade seja exibida com duas casas decimais, se necess√°rio.
                    const quantityDisplay = (typeof item.quantity === 'number') ? item.quantity.toFixed(2) : item.quantity;

                    row.innerHTML = `
                        <td class="text-sm text-gray-900">${time}</td>
                        <td class="text-sm text-gray-900">${item.material}</td>
                        <td class"text-sm text-gray-900 font-bold">${quantityDisplay}</td>
                        <td class="text-sm text-gray-500">${item.userId ? item.userId.substring(0, 8) + '...' : 'N/A'}</td>
                    `;
                    if(logTableBody) logTableBody.appendChild(row);
                });
            }

            // 3. Calcular e Renderizar o Resumo Di√°rio
            calculateSummary(filteredDepartures);
        }

        function calculateSummary(filteredDepartures) {
            if(summaryTableBody) summaryTableBody.innerHTML = '';
            const summary = {};

            // Agrega as quantidades por material
            filteredDepartures.forEach(item => {
                if (summary[item.material]) {
                    summary[item.material] += item.quantity;
                } else {
                    summary[item.material] = item.quantity;
                }
            });

            const materials = Object.keys(summary).sort();

            if (materials.length === 0) {
                if(summaryTableBody) summaryTableBody.innerHTML = `<tr><td colspan="2" class="text-center py-4 text-gray-500">Nenhum resumo para esta data.</td></tr>`;
                return;
            }

            // Renderiza a tabela de resumo
            materials.forEach(material => {
                const row = document.createElement('tr');
                row.classList.add('data-row');
                row.innerHTML = `
                    <td class="text-base font-semibold text-gray-800">${material}</td>
                    <td class="text-base font-extrabold text-green-700">${summary[material].toFixed(2)}</td>
                `;
                if(summaryTableBody) summaryTableBody.appendChild(row);
            });
        }
        
        // Inicializa a lista de sugest√µes ao carregar a p√°gina
        window.onload = fillMaterialDatalist;
    </script>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-extrabold text-indigo-800 mb-2">Controle de Estoque Di√°rio</h1>
            <p class="text-gray-600">Registre as sa√≠das de materiais do dep√≥sito e acompanhe o resumo do dia.</p>
            <p id="user-id-display" class="text-xs text-gray-400 mt-1"></p>
        </header>
        
        <!-- AVISO DE CONFIGURA√á√ÉO EXTERNA -->
        <div id="external-config-warning" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg mb-6" role="alert">
            <p class="font-bold">Aviso de Configura√ß√£o!</p>
            <p>Este aplicativo est√° usando a **configura√ß√£o manual** do Firebase. Lembre-se de verificar suas **Regras de Seguran√ßa do Firestore** para permitir acesso de leitura/escrita √† cole√ß√£o `daily_departures_data`.</p>
        </div>

        <!-- Se√ß√£o de Cadastro de Sa√≠da -->
        <div class="bg-white p-6 rounded-xl container-shadow mb-8">
            <h2 class="text-xl font-semibold text-indigo-700 mb-4 border-b pb-2">Registrar Nova Sa√≠da</h2>
            
            <div id="loading-indicator" class="text-center p-4 text-indigo-500">Carregando autentica√ß√£o...</div>

            <form id="add-departure-form" class="space-y-4"> 
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Campo Data -->
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700">Data da Sa√≠da</label>
                        <input type="date" id="date" required 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>

                    <!-- Campo Material -->
                    <div class="md:col-span-2">
                        <label for="material-name" class="block text-sm font-medium text-gray-700">Material (Ex: Piment√£o, Arroz)</label>
                        <input type="text" id="material-name" list="material-suggestions" required placeholder="Digite ou selecione o material"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        <datalist id="material-suggestions"></datalist>
                    </div>
                </div>

                <!-- Campo Quantidade -->
                <div>
                    <label for="quantity" class="block text-sm font-medium text-gray-700">Quantidade</label>
                    <input type="number" id="quantity" required min="0.01" step="0.01" placeholder="Ex: 5 ou 0.5"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>

                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center pt-2">
                    <button type="submit"
                            class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg">
                        Registrar Sa√≠da
                    </button>
                    <p id="form-status" class="text-sm mt-3 sm:mt-0 sm:ml-4 text-gray-500"></p>
                </div>
            </form>
        </div>

        <!-- Se√ß√£o de Filtro e Resumo/Log -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Tabela de Resumo Di√°rio (Total por Material) -->
            <div class="bg-white p-6 rounded-xl container-shadow">
                <h2 class="text-xl font-semibold text-green-700 mb-4 border-b pb-2">Resumo de Sa√≠das do Dia</h2>
                
                <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                    <thead>
                        <tr>
                            <th class="bg-green-600 text-white">Material</th>
                            <th class="bg-green-600 text-white">Total Sa√≠do</th>
                        </tr>
                    </thead>
                    <tbody id="summary-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Dados do Resumo ser√£o injetados aqui -->
                    </tbody>
                </table>
            </div>

            <!-- Log de Sa√≠das (Detalhe do Dia) -->
            <div class="bg-white p-6 rounded-xl container-shadow">
                <h2 class="text-xl font-semibold text-indigo-700 mb-4 border-b pb-2">Log de Sa√≠das Detalhado</h2>
                
                <div class="mb-4">
                    <label for="date-filter" class="block text-sm font-medium text-gray-700">Filtrar por Data:</label>
                    <input type="date" id="date-filter"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                        <thead>
                            <tr>
                                <th class="bg-indigo-600 text-white">Hora</th>
                                <th class="bg-indigo-600 text-white">Material</th>
                                <th class="bg-indigo-600 text-white">Qtd.</th>
                                <th class="bg-indigo-600 text-white">Registrado por</th>
                            </tr>
                        </thead>
                        <tbody id="log-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Dados do Log ser√£o injetados aqui -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

</body>
</html>

