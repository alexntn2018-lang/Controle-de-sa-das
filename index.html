<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Estoque - Pro</title>
    <!-- Carregando Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Mammoth.js para ler arquivos .docx -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <!-- IMPORTANTE: Usando xlsx-js-style para permitir cores e estilos no Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            color: #1f2937;
            min-height: 100vh;
        }
        
        /* Transições de Página */
        .page-view {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
            display: none !important; /* IMPORTANTE: Garante que suma quando não estiver active */
            width: 100%;
        }
        
        .page-view.active {
            opacity: 1;
            transform: translateY(0);
            display: block !important; 
        }

        #auth-container.active {
            display: flex !important; /* Garante o Flex apenas quando ativo */
        }

        /* Estilização Personalizada da Tabela */
        .modern-table-container {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 0.75rem;
            overflow: hidden;
            background: white;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background-color: #f8fafc;
            color: #475569;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            color: #334155;
        }
        
        .data-row {
            transition: background-color 0.2s;
        }
        .data-row:hover {
            background-color: #f8fafc;
        }

        /* Inputs Modernos */
        .input-field {
            transition: all 0.2s;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
            background-color: #fff;
        }
        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
            outline: none;
        }

        /* Botões */
        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -1px rgba(37, 99, 235, 0.4);
        }

        .btn-secondary {
            background: white;
            border: 1px solid #cbd5e1;
            color: #475569;
            font-weight: 500;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background-color: #f8fafc;
            border-color: #94a3b8;
            color: #1e293b;
        }

        /* Botão Excel Específico */
        .btn-excel {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-weight: 600;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-excel:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -1px rgba(16, 185, 129, 0.4);
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        /* Cards do Dashboard */
        .dash-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0);
            cursor: pointer;
        }
        .dash-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: #bfdbfe;
        }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }
    </style>

    <!-- Importando Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, where, getDocs, updateDoc, serverTimestamp, setLogLevel, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GERENCIAMENTO DE PÁGINAS ---
        function navigateTo(pageId) {
            document.querySelectorAll('.page-view').forEach(page => {
                page.classList.remove('active');
            });
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                window.scrollTo(0, 0);
            }
        }

        function toggleAuthForms() {
            document.getElementById('login-form-container').classList.toggle('hidden');
            document.getElementById('register-form-container').classList.toggle('hidden');
        }
        window.toggleAuthForms = toggleAuthForms;

        const firebaseConfig = {
            apiKey: "AIzaSyAd6tEf3dBDohA1TCgLn-w4UW1UKE_90tE",
            authDomain: "meu-controle-de-estoque-3344f.firebaseapp.com",
            projectId: "meu-controle-de-estoque-3344f",
            storageBucket: "meu-controle-de-estoque-3344f.appspot.com",
            messagingSenderId: "524659153893",
            appId: "1:524659153893:web:118326d46946ee60306d0c",
            measurementId: "G-BD19J1CTCZ"
        };

        setLogLevel('Debug');
        
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let allDepartures = [];
        let unsubscribe;
        
        const logTableBody = document.getElementById('log-table-body');
        const summaryTableBody = document.getElementById('summary-table-body');
        const weeklySummaryTableBody = document.getElementById('weekly-summary-table-body');
        const monthlySummaryTableBody = document.getElementById('monthly-summary-table-body');
        const dateFilterInput = document.getElementById('date-filter');
        const weekMonthFilterInput = document.getElementById('week-month-filter');
        const weekNumberFilterInput = document.getElementById('week-number-filter');
        const monthFilterInput = document.getElementById('month-filter');
        const materialInput = document.getElementById('material-name');
        const unitInput = document.getElementById('unit_of_measure');
        const formStatus = document.getElementById('form-status');
        const loadingIndicator = document.getElementById('loading-indicator');
        const userIdDisplay = document.getElementById('user-id-display');
        const addDepartureForm = document.getElementById('add-departure-form'); 
        const analysisOutput = document.getElementById('analysis-output');
        const topMonthOutput = document.getElementById('top-month-output');
        const batchUploadStatus = document.getElementById('batch-upload-status');
        const authStatus = document.getElementById('auth-status');
        const dashboardContainer = document.getElementById('dashboard-container');
        const registroContainer = document.getElementById('registro-container');
        const relatoriosContainer = document.getElementById('relatorios-container');
        const semanalContainer = document.getElementById('semanal-container');
        const mensalContainer = document.getElementById('mensal-container');

        function showDashboard() {
            [dashboardContainer].forEach(c => c.classList.remove('hidden'));
            [registroContainer, relatoriosContainer, semanalContainer, mensalContainer].forEach(c => c.classList.add('hidden'));
        }
        window.showDashboard = showDashboard;
        function showRegistro() {
            [registroContainer].forEach(c => c.classList.remove('hidden'));
            [dashboardContainer, relatoriosContainer, semanalContainer, mensalContainer].forEach(c => c.classList.add('hidden'));
        }
        window.showRegistro = showRegistro;
        function showRelatorios() {
            [relatoriosContainer].forEach(c => c.classList.remove('hidden'));
            [dashboardContainer, registroContainer, semanalContainer, mensalContainer].forEach(c => c.classList.add('hidden'));
        }
        window.showRelatorios = showRelatorios;
        function showSemanal() {
            [semanalContainer].forEach(c => c.classList.remove('hidden'));
            [dashboardContainer, registroContainer, relatoriosContainer, mensalContainer].forEach(c => c.classList.add('hidden'));
        }
        window.showSemanal = showSemanal;
        function showMensal() {
            [mensalContainer].forEach(c => c.classList.remove('hidden'));
            [dashboardContainer, registroContainer, relatoriosContainer, semanalContainer].forEach(c => c.classList.add('hidden'));
        }
        window.showMensal = showMensal;

        if (!firebaseConfig || !firebaseConfig.projectId || firebaseConfig.projectId === "SEU_PROJETO_ID") {
            console.error("CONFIGURAÇÃO DO FIREBASE INCOMPLETA!");
        } else {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        }

        const collectionPath = `saidas_materiais`;
        
        const handleRegister = (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            authStatus.style.display = 'block';
            authStatus.textContent = "Registrando...";
            authStatus.className = 'text-center text-sm text-gray-500 mt-4';
            createUserWithEmailAndPassword(auth, email, password)
                .then(() => {
                    authStatus.textContent = "Usuário registrado com sucesso! Faça o login.";
                    authStatus.className = 'text-center text-sm text-green-600 mt-4';
                    setTimeout(() => toggleAuthForms(), 1500);
                })
                .catch((error) => {
                    let msg = "Ocorreu um erro ao registrar.";
                    if (error.code === 'auth/email-already-in-use') msg = "Este e-mail já está em uso.";
                    else if (error.code === 'auth/weak-password') msg = "A senha deve ter pelo menos 6 caracteres.";
                    authStatus.textContent = `Erro: ${msg}`;
                    authStatus.className = 'text-center text-sm text-red-600 mt-4';
                });
        };
        const handleLogin = (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            authStatus.style.display = 'block';
            authStatus.textContent = "Autenticando...";
            authStatus.className = 'text-center text-sm text-gray-500 mt-4';
            signInWithEmailAndPassword(auth, email, password)
                .then(() => authStatus.style.display = 'none')
                .catch(() => {
                    authStatus.textContent = "Erro: E-mail ou senha inválidos.";
                    authStatus.className = 'text-center text-sm text-red-600 mt-4';
                });
        };
        const handleLogout = () => {
            if (unsubscribe) { unsubscribe(); unsubscribe = null; }
            signOut(auth);
        };
        
        function getWeekOfMonthDateRange(yearMonth, weekNumber) {
            const [year, month] = yearMonth.split('-').map(Number);
            let startDay, endDay;
            if (weekNumber === 'q1') {
                startDay = 1; endDay = 15;
            } else if (weekNumber === 'q2') {
                startDay = 16; endDay = new Date(year, month, 0).getDate(); 
            } else {
                const weekNum = parseInt(weekNumber, 10);
                if (weekNum === 1) { startDay = 1; endDay = 7; } 
                else if (weekNum === 2) { startDay = 8; endDay = 14; } 
                else if (weekNum === 3) { startDay = 15; endDay = 21; } 
                else { startDay = 22; endDay = new Date(year, month, 0).getDate(); }
            }
            const startDate = new Date(year, month - 1, startDay);
            const endDate = new Date(year, month - 1, endDay);
            return { start: startDate.toISOString().split('T')[0], end: endDate.toISOString().split('T')[0] };
        }
        
        function populateMonthSelectors() {
            const months = [];
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            let d = new Date();
            for (let i=0; i < 12; i++) {
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                months.push({ value: `${year}-${month}`, text: `${monthNames[d.getMonth()]} de ${year}` });
                d.setMonth(d.getMonth() - 1);
            }
            weekMonthFilterInput.innerHTML = months.map(m => `<option value="${m.value}">${m.text}</option>`).join('');
            if(monthFilterInput) { monthFilterInput.value = months[0].value; }
        }

        if (auth) {
            onAuthStateChanged(auth, (user) => {
                loadingIndicator.style.display = 'none';
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    userIdDisplay.textContent = `${user.email}`;
                    navigateTo('main-app-container');
                    showDashboard();
                    const today = new Date();
                    document.getElementById('date').value = today.toISOString().split('T')[0];
                    document.getElementById('date-filter').value = today.toISOString().split('T')[0];
                    const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                    monthFilterInput.value = currentMonth;
                    populateMonthSelectors();
                    weekMonthFilterInput.value = currentMonth;
                    if (!unsubscribe) setupRealtimeListener();
                } else {
                    userId = null; isAuthReady = false;
                    navigateTo('auth-container');
                }
            });
        }
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('register-form').addEventListener('submit', handleRegister);
        document.getElementById('logout-button').addEventListener('click', handleLogout);
        
        async function registerDeparture(material, quantity, date, destination, unit) {
            if (!isAuthReady) return false;
            if (!material || isNaN(quantity) || quantity <= 0 || !date || !destination || !unit) {
                formStatus.textContent = `Preencha todos os campos corretamente.`;
                formStatus.className = 'text-sm mt-3 sm:mt-0 sm:ml-4 font-semibold text-red-600';
                return false;
            }
            const materialUpper = material.toUpperCase();
            const destinationUpper = destination.toUpperCase();
            const unitUpper = unit.toUpperCase();
            try {
                const q = query(
                    collection(db, collectionPath),
                    where("date", "==", date),
                    where("material", "==", materialUpper),
                    where("destination", "==", destinationUpper),
                    where("unit_of_measure", "==", unitUpper)
                );
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    const docToUpdate = querySnapshot.docs[0];
                    const currentData = docToUpdate.data();
                    const newQuantity = currentData.quantity + quantity;
                    await updateDoc(doc(db, collectionPath, docToUpdate.id), {
                        quantity: newQuantity,
                        timestamp: serverTimestamp()
                    });
                    formStatus.textContent = `Atualizado: ${material} (Total: ${newQuantity} ${unitUpper})`;
                } else {
                    await addDoc(collection(db, collectionPath), {
                        material: materialUpper, quantity, date, destination: destinationUpper, unit_of_measure: unitUpper,
                        timestamp: serverTimestamp(), userId, userEmail: auth.currentUser.email
                    });
                    formStatus.textContent = `Saída de "${material}" registrada.`;
                }
                formStatus.className = 'text-sm mt-3 sm:mt-0 sm:ml-4 font-semibold text-green-600';
                return true;
            } catch (e) {
                console.error("Erro ao reg
